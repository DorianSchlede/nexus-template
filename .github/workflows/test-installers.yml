name: Test Installers

on:
  push:
    branches: [ main, nexus-template-v5 ]
    paths:
      - 'install.sh'
      - 'install.ps1'
      - '.github/workflows/test-installers.yml'
  pull_request:
    branches: [ main, nexus-template-v5 ]
    paths:
      - 'install.sh'
      - 'install.ps1'
      - '.github/workflows/test-installers.yml'
  workflow_dispatch:

jobs:
  test-bash-syntax:
    name: Bash Syntax Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate Bash Syntax
        run: |
          bash -n install.sh
          echo "✓ Bash syntax valid"

      - name: Check Line Endings
        run: |
          if file install.sh | grep -q "CRLF"; then
            echo "✗ CRLF line endings detected (must be LF)"
            exit 1
          fi
          echo "✓ LF line endings (correct)"

      - name: Verify Functions Exist
        run: |
          functions=(
            "detect_platform"
            "check_tool"
            "install_claude_code"
            "install_uv"
            "install_git"
            "prompt_vscode"
            "clone_nexus"
            "show_summary"
            "main"
          )

          for func in "${functions[@]}"; do
            if grep -q "${func}()" install.sh; then
              echo "✓ ${func}() found"
            else
              echo "✗ ${func}() missing"
              exit 1
            fi
          done

  test-powershell-syntax:
    name: PowerShell Syntax Check
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate PowerShell Syntax
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          try {
            $null = [scriptblock]::Create((Get-Content .\install.ps1 -Raw))
            Write-Host "[OK] PowerShell syntax valid"
          } catch {
            Write-Error "[X] PowerShell syntax error: $_"
            exit 1
          }

      - name: Check Line Endings
        shell: powershell
        run: |
          $content = Get-Content .\install.ps1 -Raw
          if ($content -match "`r`n") {
            Write-Host "[OK] CRLF line endings (correct for PowerShell)"
          } else {
            Write-Error "[X] LF line endings detected (should be CRLF for PowerShell)"
            exit 1
          }

      - name: Verify Functions Exist
        shell: powershell
        run: |
          $functions = @(
            "Get-PlatformInfo",
            "Test-CommandExists",
            "Install-ClaudeCode",
            "Install-Uv",
            "Install-Git",
            "Invoke-VsCodePrompt",
            "Invoke-NexusClone",
            "Show-Summary",
            "Main"
          )

          $content = Get-Content .\install.ps1 -Raw
          foreach ($func in $functions) {
            if ($content -match "function $func") {
              Write-Host "[OK] $func found"
            } else {
              Write-Error "[X] $func missing"
              exit 1
            }
          }

  test-bash-integration:
    name: Integration Test (Ubuntu)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Installer (Non-Interactive)
        run: |
          # Provide automated inputs:
          # - VS Code: No (2)
          # - Nexus dir: /tmp/nexus-test
          # - Overwrite: No
          echo -e "2\n/tmp/nexus-test\nn" | bash install.sh
        env:
          TERM: xterm-256color

      - name: Verify Claude Code Installed
        run: |
          if command -v claude &> /dev/null; then
            echo "✓ Claude Code installed"
            claude --version || echo "Note: claude --version may fail in CI (expected)"
          else
            echo "⚠ Claude Code not in PATH (may require terminal restart)"
          fi

      - name: Verify uv Installed
        run: |
          if command -v uv &> /dev/null; then
            echo "✓ uv installed"
            uv --version
          elif [ -f "$HOME/.local/bin/uv" ]; then
            echo "✓ uv installed at ~/.local/bin/uv"
            $HOME/.local/bin/uv --version
          else
            echo "⚠ uv not found (may require terminal restart)"
          fi

      - name: Verify Git Installed
        run: |
          if command -v git &> /dev/null; then
            echo "✓ Git installed"
            git --version
          else
            echo "✗ Git not installed"
            exit 1
          fi

      - name: Verify Nexus Cloned
        run: |
          if [ -d "/tmp/nexus-test" ]; then
            echo "✓ Nexus cloned to /tmp/nexus-test"
            ls -la /tmp/nexus-test
          else
            echo "✗ Nexus not cloned"
            exit 1
          fi

  test-powershell-integration:
    name: Integration Test (Windows)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Installer (Non-Interactive)
        shell: powershell
        run: |
          # Run installer with default paths (accepts defaults via Enter)
          # Note: Read-Host doesn't reliably read from pipeline in CI
          # So we accept defaults: VS Code=No(2), Nexus dir=default ($HOME\nexus)
          echo "2" | .\install.ps1

      - name: Verify Claude Code Installed
        shell: powershell
        run: |
          try {
            $version = claude --version 2>&1
            Write-Host "[OK] Claude Code installed: $version"
          } catch {
            Write-Host "[!] Claude Code not in PATH (may require terminal restart)"
          }

      - name: Verify uv Installed
        shell: powershell
        run: |
          try {
            $version = uv --version
            Write-Host "[OK] uv installed: $version"
          } catch {
            Write-Host "[!] uv not in PATH (may require terminal restart)"
          }

      - name: Verify Git Installed
        shell: powershell
        run: |
          try {
            $version = git --version
            Write-Host "[OK] Git installed: $version"
          } catch {
            Write-Error "[X] Git not installed"
            exit 1
          }

      - name: Verify Claude Can Run
        shell: powershell
        run: |
          # Test if Claude can actually execute (not just installed)
          try {
            # Add Claude to PATH for current session
            $env:Path = "C:\Users\runneradmin\.local\bin;$env:Path"

            # Run claude --help (doesn't require auth)
            $output = claude --help 2>&1
            if ($output -match "Claude Code") {
              Write-Host "[OK] Claude executable works: $(claude --version)"
              Write-Host "[OK] Claude is functional and can run commands"
            } else {
              Write-Error "[X] Claude did not produce expected output"
              exit 1
            }
          } catch {
            Write-Error "[X] Claude failed to execute: $_"
            exit 1
          }

  test-idempotency:
    name: Idempotency Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Installer First Time
        run: |
          echo -e "2\n/tmp/nexus-first\nn" | bash install.sh
        env:
          TERM: xterm-256color

      - name: Run Installer Second Time (same system)
        run: |
          echo -e "2\n/tmp/nexus-second\nn" | bash install.sh
        env:
          TERM: xterm-256color

      - name: Verify No Errors on Second Run
        run: |
          echo "✓ Installer is idempotent (can run multiple times)"
          if [ -d "/tmp/nexus-first" ] && [ -d "/tmp/nexus-second" ]; then
            echo "✓ Both Nexus directories created"
          else
            echo "✗ Idempotency test failed"
            exit 1
          fi

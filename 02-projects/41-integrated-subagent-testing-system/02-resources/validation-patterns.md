# Validation Patterns - Research Pipeline Analysis

**Source**: Subagent analysis of `03-skills/research-pipeline/scripts/`
**Agent ID**: a5035bc
**Date**: 2026-01-07

---

## 1. Task Allocation Pattern (Greedy Bin-Packing)

**File**: `calculate_subagent_allocation.py`

### Token Budget System
- **Token budget per batch**: 70,000 tokens
- **Methodology overhead**: ~10% reserved
- **Output reservation**: ~20% for synthesis

### Greedy Bin-Packing Algorithm
```python
def allocate_sources_to_subagents(sources, token_budget=70000):
    """
    Greedy bin-packing: assigns sources to subagents until budget exhausted.
    Returns list of batches, each with sources that fit within budget.
    """
    batches = []
    current_batch = []
    current_tokens = 0

    for source in sorted(sources, key=lambda s: s.token_count, reverse=True):
        if current_tokens + source.token_count <= token_budget:
            current_batch.append(source)
            current_tokens += source.token_count
        else:
            if current_batch:
                batches.append(current_batch)
            current_batch = [source]
            current_tokens = source.token_count

    if current_batch:
        batches.append(current_batch)

    return batches
```

### Key Insight
Sources are sorted **largest-first** to minimize wasted space in batches.

---

## 2. Quote-Line Verification Pattern

**File**: `verify_subagent_output.py`

### Verification Parameters
- **Line tolerance**: ±5 lines from claimed location
- **Character comparison**: First 50 characters
- **Pass threshold**: 90% of quotes must verify

### Verification Logic
```python
def verify_quote(quote, source_content, claimed_line):
    """
    Verify quote exists in source within tolerance window.
    """
    lines = source_content.split('\n')
    start = max(0, claimed_line - 5)
    end = min(len(lines), claimed_line + 5)

    search_window = '\n'.join(lines[start:end])
    quote_prefix = quote[:50]  # First 50 chars

    return quote_prefix in search_window
```

### Batch Verification
```python
def verify_batch(quotes, sources):
    """
    Verify all quotes in batch, return pass/fail percentage.
    """
    verified = 0
    total = len(quotes)

    for quote in quotes:
        if verify_quote(quote.text, quote.source, quote.line):
            verified += 1

    pass_rate = verified / total if total > 0 else 0
    return pass_rate >= 0.90  # 90% threshold
```

---

## 3. Evidence Anti-Hallucination Pattern

**File**: `validate_analysis.py`

### 3-Point Evidence Requirement
Every claim must have evidence from:
1. **Start** - Quote from beginning of source
2. **Middle** - Quote from middle section
3. **End** - Quote from end section

### Evidence Structure
```python
@dataclass
class EvidencePoint:
    quote: str
    source_file: str
    line_number: int
    section: Literal["start", "middle", "end"]

@dataclass
class Claim:
    statement: str
    evidence: List[EvidencePoint]  # Must have 3 points

    def is_valid(self):
        sections = {e.section for e in self.evidence}
        return sections == {"start", "middle", "end"}
```

---

## 4. Fuzzy Deduplication Pattern

**File**: `validate_synthesis.py`

### Similarity Threshold
- **Threshold**: 0.7 (70% similarity)
- **Method**: Sequence matching

### Deduplication Logic
```python
from difflib import SequenceMatcher

def is_duplicate(text1, text2, threshold=0.7):
    """Check if two texts are duplicates using fuzzy matching."""
    ratio = SequenceMatcher(None, text1, text2).ratio()
    return ratio >= threshold

def deduplicate_findings(findings):
    """Remove duplicate findings across subagent outputs."""
    unique = []
    for finding in findings:
        is_dup = any(is_duplicate(finding.text, u.text) for u in unique)
        if not is_dup:
            unique.append(finding)
    return unique
```

---

## 5. Validation Pipeline Integration

### Full Validation Flow
```
Subagent Output → Quote Verification → Evidence Check → Deduplication → Validated Output
                       (90%+)           (3-point)        (0.7 sim)
```

### Quality Gates
| Gate | Threshold | Action on Fail |
|------|-----------|----------------|
| Quote Verification | 90% | Reject batch |
| Evidence Points | 3 per claim | Flag for review |
| Duplicate Check | 0.7 similarity | Merge findings |

---

## Key Patterns for Project 41

1. **Token budget constraints** are critical for parallel subagent work
2. **±5 line tolerance** handles formatting variations
3. **3-point evidence** prevents hallucination effectively
4. **0.7 similarity threshold** catches near-duplicates without over-merging

---

*Generated by validation subagent analysis*

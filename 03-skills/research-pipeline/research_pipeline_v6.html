<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Research Pipeline - 10x Visualization</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #09090b;
            --bg-secondary: #0f0f12;
            --bg-tertiary: #18181b;
            --bg-elevated: #1f1f23;
            --bg-card: #141417;
            --bg-hover: #1c1c20;
            --border: #27272a;
            --border-subtle: #1f1f23;
            --border-bright: #3f3f46;
            --text-primary: #fafafa;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --text-dim: #52525b;

            /* Vibrant accent colors */
            --accent-emerald: #10b981;
            --accent-blue: #3b82f6;
            --accent-violet: #8b5cf6;
            --accent-amber: #f59e0b;
            --accent-rose: #f43f5e;
            --accent-cyan: #06b6d4;
            --accent-lime: #84cc16;
            --accent-pink: #ec4899;

            /* Glow effects */
            --glow-emerald: rgba(16, 185, 129, 0.15);
            --glow-blue: rgba(59, 130, 246, 0.15);
            --glow-violet: rgba(139, 92, 246, 0.15);

            /* Phase colors */
            --phase-a: #22c55e;
            --phase-b: #3b82f6;
            --phase-c: #f59e0b;
            --phase-d: #a855f7;
            --phase-e: #ec4899;
            --phase-f: #14b8a6;
            --phase-g: #6366f1;
            --phase-h: #f97316;
            --phase-i: #8b5cf6;

            --sidebar-width: 340px;
            --header-height: 64px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* ===== LAYOUT ===== */
        .app {
            display: flex;
            min-height: 100vh;
        }

        /* ===== SIDEBAR ===== */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            overflow: hidden;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(180deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
            flex-shrink: 0;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent-emerald) 0%, var(--accent-cyan) 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .logo-text {
            font-size: 18px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-emerald) 0%, var(--accent-cyan) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logo-version {
            font-size: 11px;
            color: var(--text-muted);
            font-weight: 500;
        }

        /* Mini stats in sidebar */
        .sidebar-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .sidebar-stat {
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 10px 8px;
            text-align: center;
        }

        .sidebar-stat-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--accent-cyan);
        }

        .sidebar-stat-label {
            font-size: 9px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .nav {
            flex: 1;
            overflow-y: auto;
            padding: 12px 0;
        }

        .nav::-webkit-scrollbar {
            width: 6px;
        }

        .nav::-webkit-scrollbar-track {
            background: transparent;
        }

        .nav::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        .nav-section {
            margin-bottom: 4px;
        }

        .nav-section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 20px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            position: relative;
        }

        .nav-section-header:hover {
            background: var(--bg-hover);
        }

        .nav-section-header.active {
            background: var(--glow-blue);
            border-left-color: var(--accent-blue);
        }

        .nav-section-header::after {
            content: '›';
            position: absolute;
            right: 16px;
            font-size: 14px;
            color: var(--text-muted);
            transition: transform 0.2s;
        }

        .nav-section.expanded .nav-section-header::after {
            transform: rotate(90deg);
        }

        .nav-section-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .nav-section-icon.create {
            background: linear-gradient(135deg, var(--phase-a) 0%, #059669 100%);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }
        .nav-section-icon.analyze {
            background: linear-gradient(135deg, var(--phase-b) 0%, #2563eb 100%);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        .nav-section-icon.synthesize {
            background: linear-gradient(135deg, var(--phase-d) 0%, #7c3aed 100%);
            box-shadow: 0 4px 12px rgba(168, 85, 247, 0.3);
        }

        .nav-section-info {
            flex: 1;
            min-width: 0;
        }

        .nav-section-title {
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .nav-section-meta {
            font-size: 11px;
            color: var(--text-muted);
            display: flex;
            gap: 8px;
        }

        .nav-items {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: rgba(0,0,0,0.2);
        }

        .nav-section.expanded .nav-items {
            max-height: 3000px;
        }

        .nav-phase {
            padding: 10px 20px 6px 52px;
            font-size: 10px;
            font-weight: 700;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-phase::before {
            content: '';
            width: 20px;
            height: 1px;
            background: var(--border);
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px 10px 52px;
            cursor: pointer;
            transition: all 0.15s;
            border-left: 3px solid transparent;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .nav-item:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: rgba(6, 182, 212, 0.1);
            border-left-color: var(--accent-cyan);
            color: var(--accent-cyan);
        }

        .nav-item-step {
            width: 28px;
            height: 22px;
            background: var(--bg-elevated);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            flex-shrink: 0;
        }

        .nav-item.active .nav-item-step {
            background: var(--accent-cyan);
            color: var(--bg-primary);
        }

        .nav-item-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .nav-item-badges {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
        }

        .nav-badge {
            width: 18px;
            height: 18px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }

        .nav-badge.gate { background: var(--accent-amber); color: #000; }
        .nav-badge.subagent { background: var(--accent-violet); color: #fff; }
        .nav-badge.script { background: var(--accent-cyan); color: #000; }
        .nav-badge.level { background: var(--accent-rose); color: #fff; font-size: 9px; font-weight: 700; }

        /* ===== MAIN CONTENT ===== */
        .main {
            flex: 1;
            margin-left: var(--sidebar-width);
            min-height: 100vh;
        }

        /* ===== HERO ===== */
        .hero {
            background: linear-gradient(180deg, var(--bg-tertiary) 0%, var(--bg-primary) 100%);
            padding: 48px 48px 40px;
            border-bottom: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        .hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--accent-cyan), var(--accent-violet), transparent);
        }

        .hero-content {
            position: relative;
            z-index: 1;
        }

        .hero-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(6, 182, 212, 0.1);
            border: 1px solid rgba(6, 182, 212, 0.3);
            border-radius: 20px;
            padding: 6px 14px;
            font-size: 11px;
            font-weight: 600;
            color: var(--accent-cyan);
            margin-bottom: 16px;
        }

        .hero-title {
            font-size: 42px;
            font-weight: 800;
            margin-bottom: 12px;
            letter-spacing: -1px;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--text-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .hero-subtitle {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 32px;
            max-width: 600px;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 12px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            transition: all 0.2s;
        }

        .stat-card:hover {
            border-color: var(--accent-cyan);
            transform: translateY(-2px);
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-cyan) 0%, var(--accent-blue) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        /* Pipeline Diagram */
        .pipeline-diagram {
            display: flex;
            align-items: stretch;
            justify-content: center;
            gap: 0;
            margin: 0 -24px;
        }

        .pipeline-node {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 20px;
            padding: 28px 32px;
            min-width: 280px;
            text-align: left;
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .pipeline-node:hover {
            transform: translateY(-6px);
        }

        .pipeline-node.create {
            border-color: var(--phase-a);
            box-shadow: 0 8px 32px rgba(34, 197, 94, 0.15);
        }
        .pipeline-node.create:hover { box-shadow: 0 16px 48px rgba(34, 197, 94, 0.25); }

        .pipeline-node.analyze {
            border-color: var(--phase-b);
            box-shadow: 0 8px 32px rgba(59, 130, 246, 0.15);
        }
        .pipeline-node.analyze:hover { box-shadow: 0 16px 48px rgba(59, 130, 246, 0.25); }

        .pipeline-node.synthesize {
            border-color: var(--phase-d);
            box-shadow: 0 8px 32px rgba(168, 85, 247, 0.15);
        }
        .pipeline-node.synthesize:hover { box-shadow: 0 16px 48px rgba(168, 85, 247, 0.25); }

        .pipeline-node-header {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 16px;
        }

        .pipeline-node-icon {
            width: 48px;
            height: 48px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .pipeline-node.create .pipeline-node-icon { background: linear-gradient(135deg, var(--phase-a) 0%, #059669 100%); }
        .pipeline-node.analyze .pipeline-node-icon { background: linear-gradient(135deg, var(--phase-b) 0%, #2563eb 100%); }
        .pipeline-node.synthesize .pipeline-node-icon { background: linear-gradient(135deg, var(--phase-d) 0%, #7c3aed 100%); }

        .pipeline-node-title {
            font-size: 16px;
            font-weight: 700;
        }

        .pipeline-node-phase {
            font-size: 11px;
            color: var(--text-muted);
        }

        .pipeline-node-desc {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 16px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .pipeline-node-stats {
            display: flex;
            gap: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-subtle);
        }

        .pipeline-node-stat {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .pipeline-node-stat strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        .pipeline-arrow {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 8px;
            flex-shrink: 0;
        }

        .pipeline-arrow-line {
            width: 60px;
            height: 3px;
            background: linear-gradient(90deg, var(--border) 0%, var(--text-muted) 50%, var(--border) 100%);
            position: relative;
        }

        .pipeline-arrow-line::after {
            content: '→';
            position: absolute;
            right: -12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
            color: var(--text-muted);
        }

        /* Key Outputs */
        .pipeline-outputs {
            margin-top: 12px;
        }

        .pipeline-output {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--text-dim);
            padding: 4px 0;
        }

        .pipeline-output-icon {
            color: var(--accent-emerald);
        }

        /* ===== SECTIONS ===== */
        .section {
            padding: 48px;
            border-bottom: 1px solid var(--border);
            scroll-margin-top: 20px;
        }

        .section-header {
            display: flex;
            align-items: flex-start;
            gap: 20px;
            margin-bottom: 36px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .section-icon {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            flex-shrink: 0;
        }

        .section-icon.create {
            background: linear-gradient(135deg, var(--phase-a) 0%, #059669 100%);
            box-shadow: 0 8px 24px rgba(34, 197, 94, 0.3);
        }
        .section-icon.analyze {
            background: linear-gradient(135deg, var(--phase-b) 0%, #2563eb 100%);
            box-shadow: 0 8px 24px rgba(59, 130, 246, 0.3);
        }
        .section-icon.synthesize {
            background: linear-gradient(135deg, var(--phase-d) 0%, #7c3aed 100%);
            box-shadow: 0 8px 24px rgba(168, 85, 247, 0.3);
        }

        .section-info {
            flex: 1;
        }

        .section-info h2 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .section-info p {
            color: var(--text-secondary);
            font-size: 14px;
            max-width: 600px;
        }

        .section-meta {
            display: flex;
            gap: 16px;
            margin-top: 12px;
        }

        .section-meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Phase Headers */
        .phase-header {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 18px 24px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 14px;
            margin-bottom: 20px;
            margin-top: 40px;
        }

        .phase-header:first-of-type {
            margin-top: 0;
        }

        .phase-letter {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 18px;
            color: var(--bg-primary);
        }

        .phase-letter.A { background: var(--phase-a); }
        .phase-letter.B { background: var(--phase-b); }
        .phase-letter.C { background: var(--phase-c); }
        .phase-letter.D { background: var(--phase-d); }
        .phase-letter.E { background: var(--phase-e); }
        .phase-letter.F { background: var(--phase-f); }
        .phase-letter.G { background: var(--phase-g); }
        .phase-letter.H { background: var(--phase-h); }
        .phase-letter.I { background: var(--phase-i); }

        .phase-info {
            flex: 1;
        }

        .phase-name {
            font-size: 16px;
            font-weight: 700;
        }

        .phase-meta {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* ===== STEP CARDS ===== */
        .step-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            margin-bottom: 16px;
            overflow: hidden;
            transition: all 0.2s;
            scroll-margin-top: 20px;
        }

        .step-card:hover {
            border-color: var(--accent-blue);
        }

        .step-card.expanded {
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .step-card-header {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            padding: 20px 24px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .step-card-header:hover {
            background: var(--bg-hover);
        }

        .step-number {
            min-width: 44px;
            height: 44px;
            background: var(--bg-elevated);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 700;
            color: var(--accent-cyan);
            flex-shrink: 0;
            transition: all 0.2s;
        }

        .step-card.expanded .step-number {
            background: var(--accent-cyan);
            color: var(--bg-primary);
        }

        .step-info {
            flex: 1;
            min-width: 0;
        }

        .step-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .step-description {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.6;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .step-card.expanded .step-description {
            -webkit-line-clamp: unset;
        }

        .step-meta {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .step-meta-badge {
            font-size: 10px;
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .step-meta-badge.level {
            background: rgba(244, 63, 94, 0.15);
            color: var(--accent-rose);
            border: 1px solid rgba(244, 63, 94, 0.3);
        }

        .step-meta-badge.script {
            background: rgba(6, 182, 212, 0.15);
            color: var(--accent-cyan);
            border: 1px solid rgba(6, 182, 212, 0.3);
        }

        .step-meta-badge.subagent {
            background: rgba(139, 92, 246, 0.15);
            color: var(--accent-violet);
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .step-meta-badge.gate {
            background: rgba(245, 158, 11, 0.15);
            color: var(--accent-amber);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .step-badges {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
            align-items: flex-start;
        }

        .step-expand {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            transition: all 0.2s;
        }

        .step-card.expanded .step-expand {
            transform: rotate(180deg);
        }

        /* Step Content */
        .step-content {
            display: none;
            padding: 0 24px 24px;
            border-top: 1px solid var(--border-subtle);
        }

        .step-card.expanded .step-content {
            display: block;
        }

        .content-section {
            margin-top: 20px;
        }

        .content-section-title {
            font-size: 11px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .content-section-title::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border-subtle);
        }

        /* Sub-steps */
        .substeps {
            display: grid;
            gap: 8px;
        }

        .substep {
            display: flex;
            gap: 12px;
            padding: 14px 16px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            border: 1px solid var(--border-subtle);
        }

        .substep-number {
            width: 28px;
            height: 28px;
            background: var(--bg-elevated);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            flex-shrink: 0;
        }

        .substep-info {
            flex: 1;
        }

        .substep-name {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .substep-desc {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Files Grid */
        .files-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 10px;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            transition: all 0.2s;
        }

        .file-item:hover {
            border-color: var(--accent-blue);
            background: var(--bg-hover);
        }

        .file-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }

        .file-icon.input {
            background: rgba(59, 130, 246, 0.15);
            color: var(--accent-blue);
        }

        .file-icon.output {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent-emerald);
        }

        .file-info {
            flex: 1;
            min-width: 0;
        }

        .file-path {
            font-size: 12px;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-secondary);
            word-break: break-all;
        }

        .file-format {
            font-size: 10px;
            color: var(--text-dim);
            text-transform: uppercase;
            margin-top: 2px;
        }

        /* Scripts */
        .scripts-list {
            display: grid;
            gap: 10px;
        }

        .script-item {
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.08) 0%, rgba(6, 182, 212, 0.02) 100%);
            border: 1px solid rgba(6, 182, 212, 0.2);
            border-radius: 12px;
            overflow: hidden;
        }

        .script-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: rgba(0,0,0,0.2);
        }

        .script-icon {
            width: 36px;
            height: 36px;
            background: var(--accent-cyan);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .script-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent-cyan);
        }

        .script-command {
            padding: 14px 16px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--text-secondary);
            background: rgba(0,0,0,0.3);
            border-radius: 0 0 12px 12px;
            overflow-x: auto;
        }

        .script-command::before {
            content: '$ ';
            color: var(--accent-emerald);
        }

        /* Subagent Config */
        .subagent-card {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(139, 92, 246, 0.02) 100%);
            border: 1px solid rgba(139, 92, 246, 0.25);
            border-radius: 14px;
            padding: 20px;
        }

        .subagent-header {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 16px;
        }

        .subagent-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--accent-violet) 0%, #6d28d9 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 16px rgba(139, 92, 246, 0.3);
        }

        .subagent-title {
            font-size: 16px;
            font-weight: 700;
        }

        .subagent-type {
            font-size: 12px;
            color: var(--text-muted);
        }

        .subagent-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .subagent-stat {
            background: var(--bg-primary);
            border-radius: 10px;
            padding: 14px;
            text-align: center;
        }

        .subagent-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent-violet);
        }

        .subagent-stat-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .subagent-visual {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .subagent-slot {
            width: 32px;
            height: 32px;
            background: var(--accent-violet);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #fff;
            animation: pulse 2s ease-in-out infinite;
        }

        .subagent-slot:nth-child(2n) { animation-delay: 0.5s; }
        .subagent-slot:nth-child(3n) { animation-delay: 1s; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* Gate Card */
        .gate-card {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(245, 158, 11, 0.02) 100%);
            border: 1px solid rgba(245, 158, 11, 0.25);
            border-radius: 14px;
            padding: 20px;
        }

        .gate-header {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 16px;
        }

        .gate-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--accent-amber) 0%, #d97706 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 16px rgba(245, 158, 11, 0.3);
        }

        .gate-title {
            font-size: 16px;
            font-weight: 700;
        }

        .gate-subtitle {
            font-size: 12px;
            color: var(--text-muted);
        }

        .gate-options {
            display: grid;
            gap: 8px;
        }

        .gate-option {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 16px;
            background: var(--bg-primary);
            border-radius: 10px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .gate-option:hover {
            background: var(--bg-tertiary);
        }

        .gate-key {
            width: 36px;
            height: 36px;
            background: var(--accent-amber);
            color: #000;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 16px;
        }

        .gate-label {
            flex: 1;
            font-size: 14px;
        }

        /* Validation Checks */
        .validation-list {
            display: grid;
            gap: 6px;
        }

        .validation-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .validation-icon {
            color: var(--accent-emerald);
            font-weight: bold;
        }

        /* Footer */
        .footer {
            padding: 40px 48px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            text-align: center;
        }

        .footer-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .footer-logo {
            font-size: 16px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-cyan) 0%, var(--accent-violet) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .footer-meta {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Scroll Progress */
        .scroll-progress {
            position: fixed;
            top: 0;
            left: var(--sidebar-width);
            right: 0;
            height: 3px;
            background: var(--bg-tertiary);
            z-index: 1000;
        }

        .scroll-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-cyan) 0%, var(--accent-violet) 100%);
            width: 0%;
            transition: width 0.1s;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-in {
            animation: fadeIn 0.4s ease forwards;
        }

        /* Mobile responsive */
        @media (max-width: 1200px) {
            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 900px) {
            .sidebar {
                display: none;
            }
            .main {
                margin-left: 0;
            }
            .scroll-progress {
                left: 0;
            }
            .pipeline-diagram {
                flex-direction: column;
            }
            .pipeline-arrow {
                transform: rotate(90deg);
            }
        }
    </style>
</head>
<body>
    <div class="scroll-progress">
        <div class="scroll-progress-bar" id="progressBar"></div>
    </div>

    <div class="app">
        <nav class="sidebar" id="sidebar"></nav>
        <main class="main" id="main"></main>
    </div>

    <script>
    const DATA = {
  "orchestrators": [
    {
      "name": "create-research-project",
      "path": "C:\\Users\\dsber\\infinite\\auto-company\\strategy-nexus\\03-skills\\research-pipeline\\orchestrators\\create-research-project\\SKILL.md",
      "description": "Create research projects with paper selection, download, and preprocessing (Phase 1). Load when user says 'create research project', 'new research', 'start research on [topic]'. Delivers analysis-ready chunks. For EXECUTING analysis, use 'execute-research-project' skill.",
      "phases": [
        {
          "letter": "A",
          "name": "RESEARCH DEFINITION",
          "steps": [
            {
              "id": "step_0",
              "number": "0",
              "name": "Initialize Task Tracking",
              "phase": "A",
              "phase_name": "RESEARCH DEFINITION",
              "description": "MANDATORY: Use TodoWrite at start of skill: Update todos as each step completes. After completing each step, mark the corresponding checkbox in `01-planning/steps.md`: Use Edit tool to change `- [ ]` to `- [x]` for each completed task. After Step 2 (Define RQ): , update plan.md: After Step 6 (Selection Gate): , update plan.md Current State: After Step 9 (Acquisition Report): , update plan.md:...",
              "full_content": "\n\n**MANDATORY: Use TodoWrite at start of skill:**\n\n```\nTodoWrite with initial todos:\n- [ ] Create project structure (Step 1)\n- [ ] Define research question \u2192 _briefing.md (Step 2)\n- [ ] Search papers \u2192 _search_results.md (Step 3)\n- [ ] Review abstracts \u2192 _abstract_reviews.md (Step 4)\n- [ ] User selection \u2192 _selection_log.md (Step 5)\n- [ ] Selection gate approval (Step 6)\n- [ ] Download approved papers (Step 7)\n- [ ] Preprocess PDFs \u2192 chunks (Step 8)\n- [ ] Acquisition report + user gate (Step 9)\n- [ ] Generate _analysis_kit.md + validate (Step 10)\n- [ ] Generate _extraction_guide.md + validate (Step 11)\n- [ ] Generate orchestrator instructions in plan.md + validate (Step 12)\n- [ ] Readiness gate \u2192 handoff (Step 13)\n```\n\n**Update todos as each step completes.**\n\n---\n\n## Progress Tracking: steps.md and plan.md\n\n### Marking Checkboxes in steps.md\n\n**After completing each step, mark the corresponding checkbox in `01-planning/steps.md`:**\n\n| After Step | Mark Complete in steps.md |\n|------------|---------------------------|\n| Step 1 | `- [x] Create project structure` |\n| Step 2 | `- [x] Define research question and extraction schema` |\n| Step 3 | `- [x] Search academic databases` |\n| Step 4 | `- [x] Review abstracts and assess relevance` |\n| Step 5-6 | `- [x] User approves paper selection` |\n| Step 7 | `- [x] Download approved papers` |\n| Step 8 | `- [x] Preprocess PDFs to markdown chunks` |\n| Step 9 | `- [x] Verify acquisition completeness` |\n\n**Use Edit tool to change `- [ ]` to `- [x]` for each completed task.**\n\n### Updating plan.md\n\n**After Step 2 (Define RQ)**, update plan.md:\n```markdown\n## Research Question\n\n**Primary RQ**: {actual research question from _briefing.md}\n\n**Focus Areas**:\n- {focus area 1}\n- {focus area 2}\n\n## Extraction Schema\n\n| Field | Description | Priority |\n|-------|-------------|----------|\n| {field1} | {description1} | high |\n| {field2} | {description2} | medium |\n```\n\n**After Step 6 (Selection Gate)**, update plan.md Current State:\n```markdow",
              "sub_steps": [],
              "inputs": [],
              "outputs": [],
              "scripts": [],
              "script_names": [],
              "skills_used": [],
              "subagent": null,
              "gate": null,
              "handoff_to": null,
              "is_script": false,
              "level": null,
              "validation_checks": [
                "After completing each step, mark the corresponding check"
              ],
              "key_outputs": []
            },
            {
              "id": "step_1",
              "number": "1",
              "name": "Create Project Structure",
              "phase": "A",
              "phase_name": "RESEARCH DEFINITION",
              "description": "Use create-project skill internally: Result:",
              "full_content": "\n\n**Use create-project skill internally:**\n\n```bash\npython 00-system/skills/projects/create-project/scripts/init_project.py \\\n  \"{Project Name}\" --type research\n```\n\n**Result:**\n```\n02-projects/NN-{slug}/\n\u251c\u2500\u2500 01-planning/\n\u2502   \u251c\u2500\u2500 overview.md    # type: research\n\u2502   \u251c\u2500\u2500 plan.md\n\u2502   \u2514\u2500\u2500 steps.md\n\u251c\u2500\u2500 02-resources/      # Papers will go here\n\u251c\u2500\u2500 03-working/        # Selection tracking\n\u2514\u2500\u2500 04-outputs/        # Synthesis outputs (Phase 2)\n```\n\n---\n\n",
              "sub_steps": [],
              "inputs": [],
              "outputs": [],
              "scripts": [
                "python 00-system/skills/projects/create-project/scripts/init_project.py \\"
              ],
              "script_names": [
                "init_project.py"
              ],
              "skills_used": [],
              "subagent": null,
              "gate": null,
              "handoff_to": null,
              "is_script": true,
              "level": null,
              "validation_checks": [],
              "key_outputs": []
            },
            {
              "id": "step_2",
              "number": "2",
              "name": "Define Research Question (with AI Field Generation)",
              "phase": "A",
              "phase_name": "RESEARCH DEFINITION",
              "description": "Gap G5 Fix: AI-Generated Field Suggestions Gap G22a Fix: Add research_purpose field Interactive session to create `02-resources/_briefing.md`: When generating field suggestions, follow this template: Output: `02-resources/_briefing.md` Token Impact: +30-50 tokens for research_purpose (validated as acceptable)",
              "full_content": "\n\n**Gap G5 Fix: AI-Generated Field Suggestions**\n**Gap G22a Fix: Add research_purpose field**\n\nInteractive session to create `02-resources/_briefing.md`:\n\n### 2.1 Research Question\n\n```\nAI: What is your main research question?\n\nUser: \"What are foundational ontologies for digital work?\"\n```\n\n### 2.2 Research Purpose (G22a - NEW)\n\n```\nAI: Why does this research matter? What will you use the insights for?\n    (This helps subagents understand context and make better extraction decisions)\n\nUser: \"Validate the 8-entity hypothesis for our UDWO metamodel\"\n\nAI: Got it. I'll include this as research_purpose in the briefing.\n```\n\n### 2.3 AI Field Generation (G5)\n\n```\nAI: Based on your research question, I'll suggest extraction fields.\n\n   ANALYZING RESEARCH QUESTION...\n   Domain detected: {detected_domain}\n   Key concepts: {extracted_concepts}\n\n   SUGGESTED FIELDS:\n   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n   \u2502 1. {field_1}        - {description_1}                       \u2502\n   \u2502 2. {field_2}        - {description_2}                       \u2502\n   \u2502 3. {field_3}        - {description_3}                       \u2502\n   \u2502 4. {field_4}        - {description_4}                       \u2502\n   \u2502 5. {field_5}        - {description_5}                       \u2502\n   \u2502 6. {field_6}        - {description_6}                       \u2502\n   \u2502 7. {field_7}        - {description_7}                       \u2502\n   \u2502 8. {field_8}        - {description_8}                       \u2502\n   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n   FIELD QUALITY CHECK:\n   \u26a0 \"{generic_field}\" is generic - consider removing if not research-focused\n   \u2713 All other fields are domain-specific\n\n   Commands:\n   - 'ok' \u2192 Accept all fields\n   - 'remove N' \u2192 Remove field N (e.g., 'remove 6')\n   - 'add FIELD_NAME: description' \u2192 Add custom field\n   - 'edit N: new description' \u2192 Edit description\n\nUser: remove 6, add ai_integration: How ontology enables AI agents\n\nAI: Updated fields (8 total). Confirm? [Y/N]\n\nUse",
              "sub_steps": [
                {
                  "number": "2.1",
                  "name": "Research Question",
                  "description": ""
                },
                {
                  "number": "2.2",
                  "name": "Research Purpose (G22a - NEW)",
                  "description": ""
                },
                {
                  "number": "2.3",
                  "name": "AI Field Generation (G5)",
                  "description": ""
                }
              ],
              "inputs": [],
              "outputs": [
                {
                  "path": "02-resources/_briefing.md",
                  "type": "output",
                  "format": "md",
                  "description": ""
                }
              ],
              "scripts": [],
              "script_names": [],
              "skills_used": [],
              "subagent": null,
              "gate": null,
              "handoff_to": null,
              "is_script": false,
              "level": null,
              "validation_checks": [
                "Token Impact**: +30-50 tokens for research_purpose (valid"
              ],
              "key_outputs": []
            },
            {
              "id": "step_3",
              "number": "3",
              "name": "Search Papers",
              "phase": "A",
              "phase_name": "RESEARCH DEFINITION",
              "description": "Use `paper-search` skill: Output: `02-resources/_search_results.md`",
              "full_content": "\n\n**Use `paper-search` skill:**\n\n```\n[Load paper-search skill]\nSearch: \"{research question}\"\nSave to: 02-resources/_search_results.md\n```\n\n**Output: `02-resources/_search_results.md`**\n```yaml\n---\nsearch_query: \"{query}\"\nsearch_date: \"{date}\"\ntotal_results: {N}\n---\n\n# Search Results\n\n## Paper 1: {Title}\n- Authors: ...\n- Abstract: \"...\"\n- DOI: ...\n- PDF: {URL if available}\n- Status: PENDING_REVIEW\n```\n\n---\n\n# PHASE B: PAPER SELECTION\n\n",
              "sub_steps": [],
              "inputs": [],
              "outputs": [],
              "scripts": [],
              "script_names": [],
              "skills_used": [],
              "subagent": null,
              "gate": null,
              "handoff_to": null,
              "is_script": false,
              "level": null,
              "validation_checks": [],
              "key_outputs": []
            }
          ]
        },
        {
          "letter": "B",
          "name": "PAPER SELECTION",
          "steps": [
            {
              "id": "step_4",
              "number": "4",
              "name": "Review Abstracts",
              "phase": "B",
              "phase_name": "PAPER SELECTION",
              "description": "AI reads each abstract and assesses relevance: See [references/abstract_review.md](references/abstract_review.md) for scoring criteria. Output: `02-resources/_abstract_reviews.md`",
              "full_content": "\n\n**AI reads each abstract and assesses relevance:**\n\nSee [references/abstract_review.md](references/abstract_review.md) for scoring criteria.\n\n**Output: `02-resources/_abstract_reviews.md`**\n```yaml\n---\nreviewed_date: \"{date}\"\nrecommended: {N}\nflagged: {N}\nrejected: {N}\n---\n\n## Paper 1: {Title}\n- Relevance Score: 5/5\n- Recommendation: APPROVE\n- Rationale: \"...\"\n```\n\n---\n\n",
              "sub_steps": [],
              "inputs": [],
              "outputs": [],
              "scripts": [],
              "script_names": [],
              "skills_used": [],
              "subagent": null,
              "gate": null,
              "handoff_to": null,
              "is_script": false,
              "level": null,
              "validation_checks": [],
              "key_outputs": []
            },
            {
              "id": "step_5",
              "number": "5",
              "name": "User Selection",
              "phase": "B",
              "phase_name": "PAPER SELECTION",
              "description": "Present recommendations for approval: Output: `03-working/_selection_log.md`",
              "full_content": "\n\n**Present recommendations for approval:**\n\n```\nAPPROVED ({N} papers):\n  1. [x] Paper Title (5/5)\n  2. [x] Paper Title (4/5)\n\nNEEDS REVIEW ({N} papers):\n  3. [ ] Paper Title (3/5) - {concern}\n\nREJECTED ({N} papers):\n  [SKIP] Paper Title (1/5) - Wrong domain\n\nCommands: 'approve all', 'add N', 'remove N', 'show N'\n```\n\n**Output: `03-working/_selection_log.md`**\n```yaml\n---\nschema_version: \"3.0\"\nselection_date: \"{date}\"\ntotal_approved: {N}\napproved_by_user: true\nuser_instruction: \"{what user said}\"\n\n# Acquisition tracking (populated in Step 7-8)\nacquisition:\n  attempted_at: null\n  downloaded: 0\n  unavailable: 0\n  preprocessed: 0\n  chunks_total: 0\n\npapers: []\nunavailable_papers: []\n---\n```\n\n---\n\n",
              "sub_steps": [],
              "inputs": [],
              "outputs": [],
              "scripts": [],
              "script_names": [],
              "skills_used": [],
              "subagent": null,
              "gate": null,
              "handoff_to": null,
              "is_script": false,
              "level": null,
              "validation_checks": [],
              "key_outputs": []
            },
            {
              "id": "step_6",
              "number": "6",
              "name": "Selection Gate",
              "phase": "B",
              "phase_name": "PAPER SELECTION",
              "description": "Confirm paper selection before acquisition: On 'Y':: Proceed to Phase C (Acquisition)",
              "full_content": "\n\n**Confirm paper selection before acquisition:**\n\n```\nSelection complete!\n\nResearch Question: \"{RQ}\"\nPapers Selected: {N}\n\nReady to download and preprocess papers?\n\n[Y] Yes \u2192 Proceed to acquisition\n[N] No, modify selection\n[S] Save and continue later\n```\n\n**On 'Y':** Proceed to Phase C (Acquisition)\n\n---\n\n# PHASE C: PAPER ACQUISITION\n\n",
              "sub_steps": [],
              "inputs": [],
              "outputs": [],
              "scripts": [],
              "script_names": [],
              "skills_used": [],
              "subagent": null,
              "gate": {
                "name": "Selection Gate",
                "options": [
                  {
                    "key": "Y",
                    "label": "Yes \u2192 Proceed to acquisition",
                    "target": ""
                  },
                  {
                    "key": "N",
                    "label": "No, modify selection",
                    "target": ""
                  },
                  {
                    "key": "S",
                    "label": "Save and continue later",
                    "target": ""
                  }
                ]
              },
              "handoff_to": "acquisition",
              "is_script": false,
              "level": null,
              "validation_checks": [],
              "key_outputs": []
            }
          ]
        },
        {
          "letter": "C",
          "name": "PAPER ACQUISITION",
          "steps": [
            {
              "id": "step_7",
              "number": "7",
              "name": "Download Approved Papers",
              "phase": "C",
              "phase_name": "PAPER ACQUISITION",
              "description": "Download all approved papers using automated batch download: The script automatically: Resolves multiple URLs per paper (arXiv \u2192 S2 \u2192 Unpaywall \u2192 direct) Downloads in parallel with rate limiting Verifies PDFs (catches HTML error pages) Retries failed downloads with exponential backoff Generates `_download_report.md` with success/fail stats 1. **arXiv ID** (if available) - Most reliable 2. **DOI...",
              "full_content": "\n\n**Download all approved papers using automated batch download:**\n\n### Batch Download (Recommended)\n\n```bash\n# Download all papers from selection log\npython 03-skills/research-pipeline/skills/paper-search/scripts/paper_download.py \\\n  --input \"02-projects/NN-{slug}/03-working/_selection_log.md\" \\\n  --output \"02-projects/NN-{slug}/02-resources/\" \\\n  --parallel 3\n```\n\n**The script automatically:**\n- Resolves multiple URLs per paper (arXiv \u2192 S2 \u2192 Unpaywall \u2192 direct)\n- Downloads in parallel with rate limiting\n- Verifies PDFs (catches HTML error pages)\n- Retries failed downloads with exponential backoff\n- Generates `_download_report.md` with success/fail stats\n\n### URL Resolution Priority\n\n1. **arXiv ID** (if available) - Most reliable\n2. **DOI via Semantic Scholar** - Often has PDF + arXiv link\n3. **DOI via Unpaywall** - OA from repositories\n4. **Title search on arXiv** - Fallback for paywalled papers\n5. **Direct URL** - Original URL if from known OA source\n\n### Single Paper Download (Fallback)\n\nIf batch fails for specific papers, try individual downloads:\n\n```bash\n# By arXiv ID (preferred)\npython 03-skills/research-pipeline/skills/paper-search/scripts/paper_download.py \\\n  --arxiv \"2506.23998\" \\\n  --output \"02-projects/NN-{slug}/02-resources/\"\n\n# By DOI\npython 03-skills/research-pipeline/skills/paper-search/scripts/paper_download.py \\\n  --doi \"10.1177/08944393231220483\" \\\n  --output \"02-projects/NN-{slug}/02-resources/\"\n\n# By title search\npython 03-skills/research-pipeline/skills/paper-search/scripts/paper_download.py \\\n  --title \"Paper Title Here\" \\\n  --output \"02-projects/NN-{slug}/02-resources/\"\n```\n\n### Progress Display\n\n```\nDownloading papers...\n  [1/25] Auto-TA (arxiv:2506.23998)... OK\n  [2/25] SFT-TA (arxiv:2509.17167)... OK\n  [3/25] Thematic-LM (ACM DOI)... UNAVAILABLE (paywall)\n  [4/25] De Paoli (SAGE)... OK (via Unpaywall)\n  ...\n\nDownloaded: 18/25\nUnavailable: 7 (paywalled, no OA version)\n```\n\n### Update _selection_log.md\n\nAfter downloads, update the selecti",
              "sub_steps": [],
              "inputs": [],
              "outputs": [],
              "scripts": [
                "python 03-skills/research-pipeline/skills/paper-search/scripts/paper_download.py \\"
              ],
              "script_names": [
                "paper_download.py"
              ],
              "skills_used": [],
              "subagent": null,
              "gate": null,
              "handoff_to": null,
              "is_script": true,
              "level": null,
              "validation_checks": [],
              "key_outputs": []
            },
            {
              "id": "step_8",
              "number": "8",
              "name": "Preprocess PDFs \u2192 Chunks",
              "phase": "C",
              "phase_name": "PAPER ACQUISITION",
              "description": "Convert all downloaded PDFs to markdown chunks:",
              "full_content": "\n\n**Convert all downloaded PDFs to markdown chunks:**\n\n### Batch Preprocessing (Recommended)\n\n```bash\npython 03-skills/research-pipeline/skills/pdf-preprocess/scripts/pdf_to_markdown.py \\\n  \"02-projects/NN-{slug}/02-resources/\" \\\n  --batch \\\n  --recursive\n```\n\n### Custom Chunk Settings (Optional)\n\n```bash\n# Smaller chunks with more overlap\npython 03-skills/research-pipeline/skills/pdf-preprocess/scripts/pdf_to_markdown.py \\\n  \"02-projects/NN-{slug}/02-resources/\" \\\n  --batch --recursive \\\n  --max-lines 500 \\\n  --overlap 50\n```\n\n### Result Per Paper\n\n```\n02-resources/{paper}/\n\u251c\u2500\u2500 {paper}.pdf           # Original PDF\n\u251c\u2500\u2500 {paper}_1.md          # Chunk 1\n\u251c\u2500\u2500 {paper}_2.md          # Chunk 2\n\u251c\u2500\u2500 ...\n\u2514\u2500\u2500 _metadata.json        # Chunk index\n```\n\n### Progress Display\n\n```\nPreprocessing PDFs...\n  [1/18] Auto_TA... 4 chunks\n  [2/18] SFT_TA... 3 chunks\n  [3/18] De_Paoli... 5 chunks\n  ...\n\nPreprocessed: 18 papers \u2192 52 chunks total\n```\n\n### Update _selection_log.md\n\n```yaml\nacquisition:\n  attempted_at: \"2025-12-19T14:30:00\"\n  downloaded: 18\n  unavailable: 7\n  preprocessed: 18\n  chunks_total: 52\n\npapers:\n  - id: \"Auto_TA\"\n    status: \"ready\"        # ready = downloaded + preprocessed\n    chunks: 4\n```\n\n---\n\n",
              "sub_steps": [],
              "inputs": [],
              "outputs": [],
              "scripts": [
                "python 03-skills/research-pipeline/skills/pdf-preprocess/scripts/pdf_to_markdown.py \\"
              ],
              "script_names": [
                "pdf_to_markdown.py"
              ],
              "skills_used": [],
              "subagent": null,
              "gate": null,
              "handoff_to": null,
              "is_script": true,
              "level": null,
              "validation_checks": [],
              "key_outputs": []
            },
            {
              "id": "step_9",
              "number": "9",
              "name": "Acquisition Report + User Gate",
              "phase": "C",
              "phase_name": "PAPER ACQUISITION",
              "description": "Present acquisition results for user approval: After acquisition complete, populate the Paper Corpus table in plan.md: Calculate subagent allocation based on chunk count: <=4 chunks \u2192 1 subagent 5-12 chunks \u2192 1 subagent >12 chunks \u2192 2 subagents (split at chunk 6) Also update Current State: If <50% of papers acquired:",
              "full_content": "\n\n**Present acquisition results for user approval:**\n\n```\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\nPAPER ACQUISITION COMPLETE\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\n\nResearch Project: {name}\n\n\u2713 Downloaded:    18 papers\n\u2717 Unavailable:   7 papers (paywalled)\n\u2713 Preprocessed:  18 papers \u2192 52 chunks\n\nUnavailable papers:\n  \u2022 Thematic-LM (ACM paywall)\n  \u2022 LLM-in-the-loop (ACL paywall)\n  \u2022 CollabCoder (ACM paywall)\n  \u2022 ... (+4 more)\n\nReady to proceed with 18 papers?\n\n[Y] Yes, proceed to execution\n[R] Retry failed downloads\n[A] Add alternative papers (search again)\n[S] Save and continue later\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\n```\n\n### Decision Handling\n\n| User Input | Action |\n|------------|--------|\n| **Y** | Proceed to Step 10 (Readiness Gate) |\n| **R** | Retry downloads (try alternative URLs) |\n| **A** | Return to Step 3 (search for alternatives) |\n| **S** | Save state, exit (can resume later) |\n\n### Update plan.md with Paper Corpus\n\n**After acquisition complete, populate the Paper Corpus table in plan.md:**\n\n```markdown\n## Paper Corpus\n\n### Papers Ready for Analysis\n\n| Paper ID | Chunks | Est. Tokens | Subagents | Status |\n|----------|--------|-------------|-----------|--------|\n| Auto_TA | 4 | ~20,000 | 1 | ready |\n| SFT_TA | 3 | ~15,000 | 1 | ready |\n| De_Paoli_2024 | 8 | ~40,000 | 1 | ready |\n| Large_Paper | 14 | ~85,000 | 2 | ready |\n\n### Unavailable Papers\n\n| Paper | Reason |\n|-------|--------|\n| Thematic-LM | ACM paywall |\n| CollabCoder | ACM paywall |\n```\n\n**Calculate subagent allocation based on chunk count:**\n- <=4 chunks \u2192 1 subagent\n- 5-12 chunks \u2192 1 subagent\n- >12 chunks \u2192 2 subagents (split at chunk 6)\n\n**Also update Current State:**\n```markdown\n## Current State\n\n| Metric | Value |\n|--------|-------|\n| Phase | 3-Acquisition (complete) |\n| Papers Approved | 25 |\n| Papers Downloaded | 18 |\n| Papers with Chunks | 18 |\n| Papers Analyzed | 0 |\n| Total Chunks | 52 |\n```\n\n### Minimum Threshold\n\nIf <50% of papers acquired:\n```\n\u26a0\ufe0f WARNING: Only {N} ",
              "sub_steps": [],
              "inputs": [],
              "outputs": [],
              "scripts": [],
              "script_names": [],
              "skills_used": [],
              "subagent": null,
              "gate": {
                "name": "Acquisition Report + User Gate",
                "options": [
                  {
                    "key": "Y",
                    "label": "Yes, proceed to execution",
                    "target": ""
                  },
                  {
                    "key": "S",
                    "label": "Save and continue later",
                    "target": ""
                  },
                  {
                    "key": "R",
                    "label": "Retry failed downloads",
                    "target": ""
                  },
                  {
                    "key": "A",
                    "label": "Add alternative papers (search again)",
                    "target": ""
                  }
                ]
              },
              "handoff_to": "execution",
              "is_script": false,
              "level": null,
              "validation_checks": [],
              "key_outputs": []
            }
          ]
        },
        {
          "letter": "D",
          "name": "READINESS GATE",
          "steps": [
            {
              "id": "step_10",
              "number": "10",
              "name": "Generate Analysis Kit",
              "phase": "D",
              "phase_name": "READINESS GATE",
              "description": "Create `_analysis_kit.md` for subagent context: This file consolidates everything subagents need to analyze papers, eliminating redundant reads. Use template from:: `references/analysis_kit_template.md` Populate with: Research question from `_briefing.md` Extraction schema (fields, descriptions, priorities) Focus areas Validation contract (required frontmatter fields) Output::...",
              "full_content": "\n\n**Create `_analysis_kit.md` for subagent context:**\n\nThis file consolidates everything subagents need to analyze papers, eliminating redundant reads.\n\n**Use template from:** `references/analysis_kit_template.md`\n\n**Populate with:**\n- Research question from `_briefing.md`\n- Extraction schema (fields, descriptions, priorities)\n- Focus areas\n- Validation contract (required frontmatter fields)\n\n**Output:** `02-resources/_analysis_kit.md`\n\n```markdown\n---\nproject_id: \"{project_id}\"\nproject_path: \"02-projects/{project_id}\"\ngenerated: \"{date}\"\n---\n\n# Analysis Kit for {project_name}\n\n## Research Question\n{from _briefing.md}\n\n## Extraction Schema\n| Field | Description | Priority |\n|-------|-------------|----------|\n{from _briefing.md extraction_schema}\n\n## Validation Contract\nYour output will be validated:\n- chunks_read == chunks_expected\n- analysis_complete == true\n- high_priority_fields_found >= 1\n```\n\n### Step 10 Validation\n\n**After creating `_analysis_kit.md`, verify:**\n\n```python\nkit = read(\"02-resources/_analysis_kit.md\")\nassert kit.frontmatter.project_id == project_id, \"Wrong project_id\"\nassert kit.frontmatter.generated is not None, \"Missing timestamp\"\nassert \"## Research Question\" in kit, \"Missing research question section\"\nassert \"## Extraction Schema\" in kit, \"Missing extraction schema\"\nassert \"## Validation Contract\" in kit, \"Missing validation contract\"\n```\n\n**If validation fails:** Regenerate the file before proceeding.\n\n---\n\n",
              "sub_steps": [],
              "inputs": [
                {
                  "path": "_briefing.md",
                  "type": "input",
                  "format": "md",
                  "description": ""
                }
              ],
              "outputs": [
                {
                  "path": "_analysis_kit.md",
                  "type": "output",
                  "format": "md",
                  "description": ""
                }
              ],
              "scripts": [],
              "script_names": [],
              "skills_used": [],
              "subagent": null,
              "gate": null,
              "handoff_to": null,
              "is_script": false,
              "level": null,
              "validation_checks": [
                "kit.frontmatter.project_id == project_id",
                "kit.frontmatter.generated is not None",
                "\"## Research Question\" in kit",
                "\"## Extraction Schema\" in kit",
                "\"## Validation Contract\" in kit",
                "After creating `_analysis_kit.md`, verify",
                "If valid"
              ],
              "key_outputs": []
            },
            {
              "id": "step_11",
              "number": "11",
              "name": "Generate Extraction Guide",
              "phase": "D",
              "phase_name": "READINESS GATE",
              "description": "Create `_extraction_guide.md` with project-specific extraction examples: Use template from:: `03-skills/research-pipeline/shared/paper-analyze-core/references/extraction_guide_template.md` Populate with: Field-specific examples for EACH field in `_briefing.md` Controlled vocabulary for this domain Good/bad extraction examples Output:: `02-resources/_extraction_guide.md` After creating...",
              "full_content": "\n\n**Create `_extraction_guide.md` with project-specific extraction examples:**\n\n**Use template from:** `03-skills/research-pipeline/shared/paper-analyze-core/references/extraction_guide_template.md`\n\n**Populate with:**\n- Field-specific examples for EACH field in `_briefing.md`\n- Controlled vocabulary for this domain\n- Good/bad extraction examples\n\n**Output:** `02-resources/_extraction_guide.md`\n\n```markdown\n# Extraction Guide: {project_name}\n\n## Field Definitions\n\n### Field: {field_1_name}\n**Definition**: {from briefing}\n**Format**: Array of strings | Array of objects | String\n**Priority**: high | medium\n\n**Example GOOD extraction**:\n{domain-specific example}\n\n**Example BAD extraction**:\n{what to avoid}\n\n### Field: {field_2_name}\n...\n\n## Controlled Vocabulary\n\n| Term | Use When |\n|------|----------|\n| {standard_term_1} | {when paper uses synonyms} |\n| {standard_term_2} | {when paper uses synonyms} |\n```\n\n### Step 11 Validation\n\n**After creating `_extraction_guide.md`, verify:**\n\n```python\nguide = read(\"02-resources/_extraction_guide.md\")\nbriefing = read(\"02-resources/_briefing.md\")\n\n# Count fields in guide\nguide_fields = count_sections_matching(\"### Field:\")\nbriefing_fields = len(briefing.extraction_schema)\n\nassert guide_fields == briefing_fields, \\\n    f\"Field count mismatch: guide has {guide_fields}, briefing has {briefing_fields}\"\nassert \"## Controlled Vocabulary\" in guide, \"Missing controlled vocabulary section\"\n```\n\n**If validation fails:** Add missing field definitions before proceeding.\n\n---\n\n",
              "sub_steps": [],
              "inputs": [],
              "outputs": [
                {
                  "path": "_extraction_guide.md",
                  "type": "output",
                  "format": "md",
                  "description": ""
                }
              ],
              "scripts": [],
              "script_names": [],
              "skills_used": [],
              "subagent": null,
              "gate": null,
              "handoff_to": null,
              "is_script": false,
              "level": null,
              "validation_checks": [
                "guide_fields == briefing_fields",
                "\"## Controlled Vocabulary\" in guide",
                "After creating `_extraction_guide.md`, verify",
                "If valid"
              ],
              "key_outputs": []
            },
            {
              "id": "step_12",
              "number": "12",
              "name": "Generate Orchestrator Instructions + Subagent Allocation Plan",
              "phase": "D",
              "phase_name": "READINESS GATE",
              "description": "Add orchestrator instructions to `plan.md`: Use template from:: `references/orchestrator_template.md` Read each paper's `_metadata.json` and calculate subagent allocation: The allocation table MUST be written to plan.md so execute-research-project can read it: Populate with: Project path constants **Pre-calculated allocation from 12.1** (NOT dynamic calculation) Subagent prompt template with...",
              "full_content": "\n\n**Add orchestrator instructions to `plan.md`:**\n\n**Use template from:** `references/orchestrator_template.md`\n\n### 12.1: Calculate Subagent Allocation (CRITICAL)\n\n**Read each paper's `_metadata.json` and calculate subagent allocation:**\n\n```python\n# Token estimation: Each chunk \u2248 10-15k tokens (1000 lines \u00d7 ~50 chars/line)\n# Usable budget: 74k tokens per subagent (after 26k methodology overhead)\n\nallocation = []\nfor paper in papers_with_chunks:\n    metadata = read(f\"02-resources/papers/{paper}/_metadata.json\")\n    chunks = metadata.total_chunks\n    chars = metadata.total_chars\n    tokens_est = (chars / 5) * 1.3\n\n    # Allocation rules\n    if chunks <= 6:\n        subagents = 1\n        splits = [f\"1-{chunks}\"]\n    elif chunks <= 12:\n        subagents = 2\n        splits = [\"1-6\", f\"7-{chunks}\"]\n    elif chunks <= 18:\n        subagents = 3\n        splits = [\"1-6\", \"7-12\", f\"13-{chunks}\"]\n    else:\n        # Split into 5-6 chunk segments\n        subagents = ceil(chunks / 6)\n        splits = [f\"{i*6+1}-{min((i+1)*6, chunks)}\" for i in range(subagents)]\n\n    allocation.append({\n        \"paper_id\": paper,\n        \"chunks\": chunks,\n        \"tokens_est\": tokens_est,\n        \"subagents\": subagents,\n        \"splits\": splits\n    })\n```\n\n### 12.2: Write Allocation Table to plan.md\n\n**The allocation table MUST be written to plan.md so execute-research-project can read it:**\n\n```markdown\n## Subagent Allocation Plan\n\n| Paper ID | Chunks | Est. Tokens | Subagents | Splits |\n|----------|--------|-------------|-----------|--------|\n| Small_Paper | 3 | ~35,000 | 1 | 1-3 |\n| Medium_Paper | 6 | ~70,000 | 1 | 1-6 |\n| Large_Paper | 10 | ~120,000 | 2 | 1-6, 7-10 |\n| Survey_Paper | 16 | ~190,000 | 3 | 1-6, 7-12, 13-16 |\n\n**Total subagents**: 7\n**Max concurrent**: 15\n**Estimated batches**: 1\n```\n\n### 12.3: Generate Subagent Prompts\n\n**Populate with:**\n- Project path constants\n- **Pre-calculated allocation from 12.1** (NOT dynamic calculation)\n- Subagent prompt template with `{paper_id}` and ",
              "sub_steps": [
                {
                  "number": "12.1",
                  "name": "Calculate Subagent Allocation (CRITICAL)",
                  "description": "Read each paper's `_metadata.json` and calculate subagent allocation:"
                },
                {
                  "number": "12.2",
                  "name": "Write Allocation Table to plan.md",
                  "description": "The allocation table MUST be written to plan.md so execute-research-project can read it:"
                },
                {
                  "number": "12.3",
                  "name": "Generate Subagent Prompts",
                  "description": "Populate with: Project path constants **Pre-calculated allocation from 12.1** (NOT dynamic calculation) Subagent prompt template with `{paper_id}`..."
                }
              ],
              "inputs": [],
              "outputs": [],
              "scripts": [],
              "script_names": [],
              "skills_used": [],
              "subagent": null,
              "gate": null,
              "handoff_to": null,
              "is_script": false,
              "level": null,
              "validation_checks": [
                "\"## Orchestrator Instructions\" in plan",
                "\"## Subagent Allocation Plan\" in plan",
                "\"| Paper ID | Chunks |\" in plan",
                "\"**Total subagents**:\" in plan",
                "\"### Constants\" in plan",
                "\"### Phase 4: Paper Analysis\" in plan",
                "\"### Phase 4.5: Validation\" in plan",
                "\"{paper_id}\" in plan"
              ],
              "key_outputs": []
            },
            {
              "id": "step_13",
              "number": "13",
              "name": "Confirm Ready for Execution",
              "phase": "D",
              "phase_name": "READINESS GATE",
              "description": "Final verification before handoff: When Readiness Gate passes: The `execute-research-project` skill expects: Paper folders with `_metadata.json` (chunks exist) `02-resources/_briefing.md` (extraction schema) `02-resources/_analysis_kit.md` (subagent context) `02-resources/_extraction_guide.md` (field examples + vocabulary) `01-planning/plan.md` with `## Orchestrator Instructions` section...",
              "full_content": "\n\n**Final verification before handoff:**\n\n### Readiness Checks\n\n```python\n# 1. Verify at least 1 paper has chunks\npapers_with_chunks = count_papers_with_metadata_json()\nif papers_with_chunks == 0:\n    fail(\"No papers preprocessed - cannot proceed\")\n\n# 2. Verify briefing exists\nif not exists(\"02-resources/_briefing.md\"):\n    fail(\"Missing _briefing.md - research question not defined\")\n\n# 3. Verify analysis kit exists\nif not exists(\"02-resources/_analysis_kit.md\"):\n    fail(\"Missing _analysis_kit.md - run Step 10\")\n\n# 4. Verify extraction guide exists\nif not exists(\"02-resources/_extraction_guide.md\"):\n    fail(\"Missing _extraction_guide.md - run Step 11\")\n\n# 5. Verify orchestrator instructions in plan.md\nif \"## Orchestrator Instructions\" not in read(\"01-planning/plan.md\"):\n    fail(\"Missing orchestrator instructions - run Step 12\")\n\n# 6. Update overview.md\nupdate_overview(status=\"READY_FOR_EXECUTION\")\n```\n\n### Final Summary\n\n```\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\nPLANNING COMPLETE - READY FOR EXECUTION\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\n\nResearch Project: {name}\nResearch Question: \"{RQ}\"\n\nPapers ready: {N} ({chunks} chunks)\nPapers unavailable: {M}\n\nAll prerequisites met:\n  \u2713 _briefing.md (extraction schema)\n  \u2713 _analysis_kit.md (subagent context)\n  \u2713 _selection_log.md (user approved)\n  \u2713 Paper chunks ({N} papers preprocessed)\n  \u2713 plan.md (orchestrator instructions)\n  \u2713 steps.md (batch tracking)\n\nTo start analysis, say:\n  \"execute research project {name}\"\n\nThis will:\n  1. Analyze each paper (spawn subagents in batches of 10)\n  2. Validate analysis logs (Phase 4.5 hallucination check)\n  3. Retry failed papers\n  4. Generate cross-paper synthesis\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\n```\n\n---\n\n## Handoff to execute-research-project\n\n**When Readiness Gate passes:**\n\nThe `execute-research-project` skill expects:\n- Paper folders with `_metadata.json` (chunks exist)\n- `02-resources/_briefing.md` (extraction schema)\n- `02-resources/_analysis_kit.md` (s",
              "sub_steps": [],
              "inputs": [],
              "outputs": [],
              "scripts": [],
              "script_names": [],
              "skills_used": [],
              "subagent": {
                "type": "general-purpose",
                "concurrency": 1,
                "timeout": "5 min",
                "retry": 1,
                "input_contract": [],
                "output_contract": []
              },
              "gate": null,
              "handoff_to": "execute-research-project",
              "is_script": false,
              "level": null,
              "validation_checks": [
                "Paper folders with `_metadata.json` (chunks exist",
                "hallucination check",
                "v5.0: Added inline valid",
                "v5.0: Updated readiness gate to check"
              ],
              "key_outputs": [
                "_briefing.md: 02-resources/",
                "_analysis_kit.md: 02-resources/",
                "_extraction_guide.md: 02-resources/",
                "_search_results.md: 02-resources/",
                "_abstract_reviews.md: 02-resources/"
              ]
            }
          ]
        }
      ],
      "handoff_from": null,
      "handoff_to": null,
      "total_steps": 14,
      "total_gates": 2,
      "key_outputs": [],
      "version": "5.0 (2025-12-28)"
    },
    {
      "name": "analyze-research-project",
      "path": "C:\\Users\\dsber\\infinite\\auto-company\\strategy-nexus\\03-skills\\research-pipeline\\orchestrators\\analyze-research-project\\SKILL.md",
      "description": "Analyze research papers (Phase 2: analysis only). Load when user says 'analyze research project', 'execute research project', 'continue research', 'run analysis', or mentions a research project by name after planning is complete. Expects analysis-ready chunks from create-research-project. After anal",
      "phases": [
        {
          "letter": "A",
          "name": "VALIDATION",
          "steps": [
            {
              "id": "step_0",
              "number": "0",
              "name": "Initialize Task Tracking",
              "phase": "A",
              "phase_name": "VALIDATION",
              "description": "MANDATORY: Use TodoWrite at start of skill: Update todos as each step completes. At start of execution, read `01-planning/plan.md` for: Paper Corpus table (which papers to analyze) Subagent allocation rules (how many subagents per paper) Orchestrator Instructions (exact prompts for subagents) Current State (to update as execution progresses) Use the prompts in plan.md \"Orchestrator Instructions\"...",
              "full_content": "\n\n**MANDATORY: Use TodoWrite at start of skill:**\n\n```\nTodoWrite with initial todos:\n- [ ] Validate readiness (Step 1)\n- [ ] Analyze papers \u2192 index.md + _analysis_log.md (Step 2)\n- [ ] Validate analysis logs (Step 3)\n- [ ] Mark analysis READY_FOR_SYNTHESIS (Step 4)\n```\n\n**Update todos as each step completes.**\n\n---\n\n## Progress Tracking: steps.md and plan.md\n\n### Reading plan.md for Orchestrator Instructions\n\n**At start of execution, read `01-planning/plan.md` for:**\n- Paper Corpus table (which papers to analyze)\n- Subagent allocation rules (how many subagents per paper)\n- Orchestrator Instructions (exact prompts for subagents)\n- Current State (to update as execution progresses)\n\n**Use the prompts in plan.md \"Orchestrator Instructions\" section for spawning subagents.**\n\n### Marking Checkboxes in steps.md\n\n**After completing each step, mark the corresponding checkbox in `01-planning/steps.md`:**\n\n| After Step | Mark Complete in steps.md |\n|------------|---------------------------|\n| Step 2 | `- [x] Analyze papers with subagents` |\n| Step 3 | `- [x] Validate analysis logs` |\n| Step 4 | `- [x] Mark analysis ready for synthesis` |\n\n**Use Edit tool to change `- [ ]` to `- [x]` for each completed task.**\n\n### Updating plan.md Current State\n\n**After Step 2 (Analysis)**, update plan.md:\n```markdown\n## Current State\n\n| Metric | Value |\n|--------|-------|\n| Phase | 4-Analysis (complete) |\n| Papers Approved | 25 |\n| Papers Downloaded | 18 |\n| Papers with Chunks | 18 |\n| Papers Analyzed | 17 |\n| Total Chunks | 52 |\n```\n\n**Also update Paper Corpus table status column:**\n- Change `ready` to `analyzed` for each completed paper\n- Change to `failed` for papers that failed validation\n\n**After Step 4 (Analysis Complete)**, update plan.md:\n```markdown\n## Current State\n\n| Metric | Value |\n|--------|-------|\n| Phase | READY_FOR_SYNTHESIS |\n| Papers Approved | 25 |\n| Papers Downloaded | 18 |\n| Papers with Chunks | 18 |\n| Papers Analyzed | 17 |\n| Total Chunks | 52 |\n```\n\n**Next**: Run `syn",
              "sub_steps": [],
              "inputs": [
                {
                  "path": "01-planning/plan.md",
                  "type": "input",
                  "format": "md",
                  "description": ""
                }
              ],
              "outputs": [],
              "scripts": [],
              "script_names": [],
              "skills_used": [],
              "subagent": null,
              "gate": null,
              "handoff_to": null,
              "is_script": false,
              "level": null,
              "validation_checks": [
                "After completing each step, mark the corresponding check",
                "Change to `failed` for papers that failed valid"
              ],
              "key_outputs": []
            },
            {
              "id": "step_1",
              "number": "1",
              "name": "Validate Readiness",
              "phase": "A",
              "phase_name": "VALIDATION",
              "description": "Check prerequisites and paper readiness: If project was created with an older version (missing _analysis_kit.md, _extraction_guide.md, or orchestrator instructions):",
              "full_content": "\n\n**Check prerequisites and paper readiness:**\n\n### 1.1 Prerequisite Checks (Fail Fast)\n\n```python\nproject_path = \"02-projects/NN-{slug}/\"\n\n# Check briefing exists\nif not exists(project_path / \"02-resources/_briefing.md\"):\n    fail(\"\"\"\n    Missing _briefing.md - research question not defined.\n    Run 'create research project' Step 2 first.\n    \"\"\")\n\n# Check analysis kit exists\nif not exists(project_path / \"02-resources/_analysis_kit.md\"):\n    fail(\"\"\"\n    Missing _analysis_kit.md - subagent context not generated.\n    Run 'create research project' Step 10 first.\n    \"\"\")\n\n# Check extraction guide exists\nif not exists(project_path / \"02-resources/_extraction_guide.md\"):\n    fail(\"\"\"\n    Missing _extraction_guide.md - field examples not defined.\n    Run 'create research project' Step 11 first.\n    \"\"\")\n\n# Check orchestrator instructions in plan.md\nplan = read(project_path / \"01-planning/plan.md\")\nif \"## Orchestrator Instructions\" not in plan:\n    fail(\"\"\"\n    Missing orchestrator instructions in plan.md.\n    Run 'create research project' Step 12 first.\n    \"\"\")\n```\n\n### 1.2 Paper Readiness Check\n\n```python\n# Find papers with chunks (have _metadata.json)\npapers_ready = []\nfor folder in (project_path / \"02-resources/papers\").iterdir():\n    if folder.is_dir() and (folder / \"_metadata.json\").exists():\n        papers_ready.append(folder.name)\n\nif len(papers_ready) == 0:\n    fail(\"No papers preprocessed - run create-research-project first\")\n\n# Check for papers needing analysis (no index.md yet)\npapers_to_analyze = []\nfor paper in papers_ready:\n    if not (project_path / f\"02-resources/papers/{paper}/index.md\").exists():\n        papers_to_analyze.append(paper)\n```\n\n### Legacy Compatibility Check\n\nIf project was created with an older version (missing _analysis_kit.md, _extraction_guide.md, or orchestrator instructions):\n```\nThis project was created with an older version.\nMissing prerequisite files must be generated first.\n\nRun these commands to complete setup:\n  1. Generate _a",
              "sub_steps": [
                {
                  "number": "1.1",
                  "name": "Prerequisite Checks (Fail Fast)",
                  "description": ""
                },
                {
                  "number": "1.2",
                  "name": "Paper Readiness Check",
                  "description": ""
                }
              ],
              "inputs": [],
              "outputs": [],
              "scripts": [],
              "script_names": [],
              "skills_used": [],
              "subagent": null,
              "gate": null,
              "handoff_to": null,
              "is_script": false,
              "level": null,
              "validation_checks": [
                "resources/papers/{paper}/index.md\").exists"
              ],
              "key_outputs": []
            },
            {
              "id": "step_1_5",
              "number": "1.5",
              "name": "Read Pre-Calculated Subagent Allocation",
              "phase": "A",
              "phase_name": "VALIDATION",
              "description": "The allocation was calculated in Phase 1 Step 12. READ it from plan.md - DO NOT recalculate! CRITICAL: The allocation is pre-calculated in Phase 1 Step 12. Do NOT modify or recalculate here. If allocation seems wrong, go back to Phase 1 and regenerate.",
              "full_content": "\n\n**The allocation was calculated in Phase 1 Step 12. READ it from plan.md - DO NOT recalculate!**\n\n### Read Allocation Table from plan.md\n\n```python\n# Read the pre-calculated allocation from plan.md\nplan = read(f\"{project_path}/01-planning/plan.md\")\n\n# Parse the \"## Subagent Allocation Plan\" section\nallocation_table = parse_markdown_table(plan, \"## Subagent Allocation Plan\")\n\n# Expected format:\n# | Paper ID | Chunks | Est. Tokens | Subagents | Splits |\n# |----------|--------|-------------|-----------|--------|\n# | Paper_A  | 4      | ~47,000     | 1         | 1-4    |\n# | Paper_B  | 10     | ~120,000    | 2         | 1-6, 7-10 |\n\ntotal_subagents = extract_value(plan, \"**Total subagents**:\")\n```\n\n### Verify Allocation Exists\n\n```python\nif \"## Subagent Allocation Plan\" not in plan:\n    fail(\"\"\"\n    Missing subagent allocation plan in plan.md.\n    This should have been created in Phase 1 Step 12.\n    Run 'create research project' Step 12 to generate allocation.\n    \"\"\")\n```\n\n### Display Pre-Calculated Plan\n\n```\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\nSUBAGENT ALLOCATION (from plan.md)\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\n\n| Paper | Chunks | Est. Tokens | Subagents | Splits |\n|-------|--------|-------------|-----------|--------|\n| Small_Paper | 3 | ~35,000 | 1 | 1-3 |\n| Medium_Paper | 6 | ~70,000 | 1 | 1-6 |\n| Large_Paper | 10 | ~120,000 | 2 | 1-6, 7-10 |\n| Survey_Paper | 16 | ~190,000 | 3 | 1-6, 7-12, 13-16 |\n\nTotal subagents: 7\nMax concurrent: 15\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\n\nProceeding with pre-planned allocation...\n```\n\n**CRITICAL**: The allocation is pre-calculated in Phase 1 Step 12. Do NOT modify or recalculate here. If allocation seems wrong, go back to Phase 1 and regenerate.\n\n---\n\n# PHASE B: ANALYSIS\n\n",
              "sub_steps": [],
              "inputs": [],
              "outputs": [],
              "scripts": [],
              "script_names": [],
              "skills_used": [],
              "subagent": null,
              "gate": null,
              "handoff_to": null,
              "is_script": false,
              "level": null,
              "validation_checks": [],
              "key_outputs": []
            }
          ]
        },
        {
          "letter": "B",
          "name": "ANALYSIS",
          "steps": [
            {
              "id": "step_2",
              "number": "2",
              "name": "Analyze Papers",
              "phase": "B",
              "phase_name": "ANALYSIS",
              "description": "Read plan.md \"Orchestrator Instructions\" section for subagent prompts. The plan.md contains: Paper Corpus table with chunk counts and subagent allocation Exact prompts for standard papers (1 subagent) Exact prompts for large papers (2+ subagents + merge) Concurrency settings Each subagent receives explicit file access rules in its prompt: Include this INPUT CONTRACT in every subagent prompt. For...",
              "full_content": "\n\n**Read plan.md \"Orchestrator Instructions\" section for subagent prompts.**\n\nThe plan.md contains:\n- Paper Corpus table with chunk counts and subagent allocation\n- Exact prompts for standard papers (1 subagent)\n- Exact prompts for large papers (2+ subagents + merge)\n- Concurrency settings\n\n### SUBAGENT INPUT CONTRACT (STRICT - Gap G13 Fix)\n\n**Each subagent receives explicit file access rules in its prompt:**\n\n```markdown\n## INPUT CONTRACT (STRICT)\n\n### Files You MUST Read (in this order)\n1. `03-skills/research-pipeline/shared/paper-analyze-core/SKILL.md` (methodology)\n2. `{project_path}/02-resources/_briefing.md` (research question + schema)\n3. `{project_path}/02-resources/_analysis_kit.md` (subagent context)\n4. `{project_path}/02-resources/_extraction_guide.md` (field examples + vocabulary)\n5. `{paper_path}/_metadata.json` (chunk info)\n6. `{paper_path}/{paper_id}_1.md`\n7. `{paper_path}/{paper_id}_2.md`\n[... exact chunk list from _metadata.json]\n\n### Files You MUST NOT Read\n- ANY `.pdf` file\n- ANY folder except `{paper_path}/`\n- ANY file in `04-outputs/`\n- ANY other paper folder in `02-resources/papers/`\n- ANY file starting with `.` (hidden files)\n- ANY file outside project directory\n\n### Directory Traversal FORBIDDEN\n- Do NOT use `../` paths\n- Do NOT follow symbolic links\n- Stay within `{project_path}/` boundary\n\nVIOLATION = Analysis fails validation.\n```\n\n**Include this INPUT CONTRACT in every subagent prompt.**\n\n### Subagent Spawning from Pre-Calculated Allocation\n\n**For each row in the Subagent Allocation Plan table:**\n\n1. Read the `Subagents` column (pre-calculated count)\n2. Read the `Splits` column (pre-calculated chunk ranges)\n3. If `Subagents == 1` \u2192 Spawn single subagent for all chunks\n4. If `Subagents > 1` \u2192 Spawn one subagent per split range, then spawn merge subagent\n\n**Example: Large_Paper with Subagents=2, Splits=\"1-6, 7-10\"**\n```\nSpawn Task 1: Analyze chunks 1-6 \u2192 index_part1.md\nSpawn Task 2: Analyze chunks 7-10 \u2192 index_part2.md\nWait for both...\nSpaw",
              "sub_steps": [],
              "inputs": [
                {
                  "path": "_briefing.md",
                  "type": "input",
                  "format": "md",
                  "description": ""
                },
                {
                  "path": "_analysis_kit.md",
                  "type": "input",
                  "format": "md",
                  "description": ""
                },
                {
                  "path": "03-skills/research-pipeline/shared/paper-analyze-core/SKILL.md",
                  "type": "input",
                  "format": "md",
                  "description": ""
                }
              ],
              "outputs": [],
              "scripts": [],
              "script_names": [],
              "skills_used": [],
              "subagent": {
                "type": "general-purpose",
                "concurrency": 1,
                "timeout": "5 min",
                "retry": 1,
                "input_contract": [
                  "*Each subagent receives explicit file access rules in its prompt:**",
                  "skills/research-pipeline/shared/paper-analyze-core/SKILL.md` (methodology)",
                  "resources/_briefing.md` (research question + schema)",
                  "resources/_analysis_kit.md` (subagent context)",
                  "resources/_extraction_guide.md` (field examples + vocabulary)"
                ],
                "output_contract": []
              },
              "gate": null,
              "handoff_to": null,
              "is_script": false,
              "level": null,
              "validation_checks": [],
              "key_outputs": []
            },
            {
              "id": "step_3",
              "number": "3",
              "name": "Validate Analysis Logs",
              "phase": "B",
              "phase_name": "ANALYSIS",
              "description": "Run validation on each completed analysis: 1. Schema version = 2.0 2. All steps completed 3. All chunks read (recorded in log) 4. Multi-point evidence matches actual chunks 5. index.md created and valid YAML frontmatter If still failing after retry:",
              "full_content": "\n\n**Run validation on each completed analysis:**\n\n```bash\npython 03-skills/research-pipeline/skills/paper-analyze/scripts/validate_analysis.py \\\n  02-projects/NN-{slug}/02-resources/ \\\n  --output 04-outputs/_validation_report.md\n```\n\n### Validation Checks\n\n1. Schema version = 2.0\n2. All steps completed\n3. All chunks read (recorded in log)\n4. Multi-point evidence matches actual chunks\n5. index.md created and valid YAML frontmatter\n\n### Validation Results Display\n\n```\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\nVALIDATION RESULTS\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\n\n\u2713 PASSED:  16 papers (validation complete)\n\u26a0 WARNING: 1 paper (minor issues, usable)\n\u2717 FAILED:  1 paper (evidence mismatch)\n\nFailed papers:\n  \u2022 Paper_XYZ - Chunk 3 evidence mismatch\n\nRe-analyze failed papers? [Y/N]\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\n```\n\n### Handle Failures\n\n| User Input | Action |\n|------------|--------|\n| **Y** | Respawn subagent for failed papers (1 retry) |\n| **N** | Exclude from synthesis, note in report |\n\n### After Retry\n\nIf still failing after retry:\n```\nPaper_XYZ failed validation after retry.\nExcluding from synthesis. See _validation_report.md for details.\n\nContinue with {N} validated papers? [Y/N]\n```\n\n---\n\n# PHASE C: COMPLETION\n\n",
              "sub_steps": [],
              "inputs": [],
              "outputs": [],
              "scripts": [
                "python 03-skills/research-pipeline/skills/paper-analyze/scripts/validate_analysis.py \\"
              ],
              "script_names": [
                "validate_analysis.py"
              ],
              "skills_used": [],
              "subagent": {
                "type": "general-purpose",
                "concurrency": 1,
                "timeout": "5 min",
                "retry": 1,
                "input_contract": [],
                "output_contract": []
              },
              "gate": null,
              "handoff_to": null,
              "is_script": true,
              "level": null,
              "validation_checks": [
                "Run valid",
                "skills/research-pipeline/skills/paper-analyze/scripts/valid",
                "output 04-outputs/_valid"
              ],
              "key_outputs": []
            }
          ]
        },
        {
          "letter": "C",
          "name": "COMPLETION",
          "steps": [
            {
              "id": "step_4",
              "number": "4",
              "name": "Mark Analysis READY_FOR_SYNTHESIS",
              "phase": "C",
              "phase_name": "COMPLETION",
              "description": "Update project status to indicate readiness for synthesis: Note: Synthesis files are created by `synthesize-research-project` (Phase 3). When timeout occurs, subagent MUST write partial progress: On resume: , orchestrator: 1. Reads `chunks_remaining` from `_analysis_log.md` 2. Spawns subagent with `start_from_chunk: 4` 3. Subagent appends to existing index.md Resume prompt addition:...",
              "full_content": "\n\n**Update project status to indicate readiness for synthesis:**\n\n### Update overview.md\n\n```yaml\n# overview.md\nstatus: READY_FOR_SYNTHESIS\nanalysis_completed_at: \"{timestamp}\"\n```\n\n### Update plan.md Current State\n\n```markdown\n## Current State\n\n| Metric | Value |\n|--------|-------|\n| Phase | READY_FOR_SYNTHESIS |\n| Papers Analyzed | 17 |\n| Papers Validated | 16 |\n| Total Chunks | 52 |\n```\n\n### Final Summary\n\n```\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\nANALYSIS COMPLETE - READY FOR SYNTHESIS\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\n\nProject: {name}\nResearch Question: \"{RQ}\"\n\nPapers analyzed: 17/18\nValidation rate: 94%\n\nOutputs:\n  \ud83d\udccb 04-outputs/_validation_report.md (analysis validation)\n\nPer-paper analysis:\n  \ud83d\udcc1 02-resources/{paper}/index.md (17 papers)\n\nNEXT STEP:\n  Run \"synthesize research project {name}\" to generate synthesis report.\n\n  This will:\n  \u2022 Read all index.md files\n  \u2022 Spawn batch extraction subagents\n  \u2022 Aggregate patterns per field\n  \u2022 Generate full _synthesis_report.md with citations\n\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\n```\n\n---\n\n## Files Created by This Skill\n\n| File | Location | Purpose |\n|------|----------|---------|\n| `_analysis_log.md` | 02-resources/papers/{paper}/ | Validation log (v2.0) |\n| `index.md` | 02-resources/papers/{paper}/ | Analysis output with YAML frontmatter |\n| `_validation_report.md` | 04-outputs/ | Analysis validation results |\n\n**Note**: Synthesis files are created by `synthesize-research-project` (Phase 3).\n\n---\n\n## Error Handling\n\n| Step | Error | Action |\n|------|-------|--------|\n| Step 1 | No chunks found | Redirect to create-research-project |\n| Step 1 | No _briefing.md | Fail with clear message |\n| Step 2 | Subagent fails | Retry once, then mark failed |\n| Step 2 | Subagent timeout | **PARTIAL SAVE** (see below) |\n| Step 3 | Evidence mismatch | Offer re-analysis or exclusion |\n| Step 3 | Schema mismatch | Re-analyze with correct schema |\n| Step 4 | <3 papers validated | Warn, proceed with caution |\n| Step ",
              "sub_steps": [],
              "inputs": [
                {
                  "path": "_analysis_log.md",
                  "type": "input",
                  "format": "md",
                  "description": ""
                }
              ],
              "outputs": [],
              "scripts": [],
              "script_names": [],
              "skills_used": [],
              "subagent": {
                "type": "general-purpose",
                "concurrency": 1,
                "timeout": "5 min",
                "retry": 1,
                "input_contract": [
                  "*Handles**: Phase 2 (Analysis) only",
                  "*Receives from**: `create-research-project` (expects chunks + analysis kit + extraction guide + orch",
                  "*Hands off to**: `synthesize-research-project` (provides papers with index.md)"
                ],
                "output_contract": []
              },
              "gate": null,
              "handoff_to": null,
              "is_script": true,
              "level": null,
              "validation_checks": [
                "outputs/_validation_report.md (analysis valid",
                "resources/papers/{paper}/ | Valid",
                "outputs/ | Analysis valid",
                "analyze/scripts/valid",
                "v2.1: Added Step 4.5 Synthesis Validation with anti-hallucination check",
                "v3.0: Added prerequisite check"
              ],
              "key_outputs": [
                "_analysis_log.md: 02-resources/papers/{paper}/",
                "index.md: 02-resources/papers/{paper}/",
                "_validation_report.md: 04-outputs/"
              ]
            }
          ]
        }
      ],
      "handoff_from": null,
      "handoff_to": null,
      "total_steps": 6,
      "total_gates": 0,
      "key_outputs": [
        "_analysis_log.md: 02-resources/papers/{paper}/",
        "index.md: 02-resources/papers/{paper}/",
        "_validation_report.md: 04-outputs/"
      ],
      "version": "5.0 (2025-12-28)"
    },
    {
      "name": "synthesize-research-project",
      "path": "C:\\Users\\dsber\\infinite\\auto-company\\strategy-nexus\\03-skills\\research-pipeline\\orchestrators\\synthesize-research-project\\SKILL.md",
      "description": "Synthesize analyzed research papers into comprehensive reports (Phase 3). Load when user says 'synthesize research project', 'generate synthesis', 'create synthesis report', or wants cross-paper synthesis. Expects analyzed papers with index.md from analyze-research-project.",
      "phases": [
        {
          "letter": "A",
          "name": "VALIDATION",
          "steps": [
            {
              "id": "step_0",
              "number": "0",
              "name": "Initialize Task Tracking",
              "phase": "A",
              "phase_name": "VALIDATION",
              "description": "MANDATORY: Use TodoWrite at start of skill: Update todos as each step completes.",
              "full_content": "\n\n**MANDATORY: Use TodoWrite at start of skill:**\n\n```\nTodoWrite with initial todos:\n- [ ] Validate readiness (Step 1)\n- [ ] Run build_synthesis_routing.py (Step 2 - Level 1)\n- [ ] Run calculate_subagent_allocation.py (Step 3 - Level 2)\n- [ ] Run generate_subagent_prompts.py (Step 4 - Level 3)\n- [ ] Spawn batch extraction subagents (Step 5 - Level 4)\n- [ ] Run verify_subagent_output.py (Step 6 - Level 5)\n- [ ] Run aggregate_patterns.py (Step 7 - Level 6)\n- [ ] Spawn final report subagent (Step 8 - Level 7)\n- [ ] Mark project COMPLETE (Step 9)\n```\n\n**Update todos as each step completes.**\n\n---\n\n# PHASE A: VALIDATION\n\n",
              "sub_steps": [],
              "inputs": [],
              "outputs": [],
              "scripts": [],
              "script_names": [],
              "skills_used": [],
              "subagent": {
                "type": "general-purpose",
                "concurrency": 1,
                "timeout": "5 min",
                "retry": 1,
                "input_contract": [],
                "output_contract": []
              },
              "gate": null,
              "handoff_to": null,
              "is_script": true,
              "level": 1,
              "validation_checks": [],
              "key_outputs": []
            },
            {
              "id": "step_1",
              "number": "1",
              "name": "Validate Readiness",
              "phase": "A",
              "phase_name": "VALIDATION",
              "description": "Run interface validation script first (catches format mismatches): If validation fails, papers need re-analysis with the updated skill (which includes inline YAML template). Check prerequisites including chunk_index (required for 7-level routing):",
              "full_content": "\n\n**Run interface validation script first (catches format mismatches):**\n\n```bash\n# RECOMMENDED: Run validation before synthesis\npython 03-skills/research-pipeline/shared/contracts/validate_interface.py {project_path}\n```\n\nIf validation fails, papers need re-analysis with the updated skill (which includes inline YAML template).\n\n**Check prerequisites including chunk_index (required for 7-level routing):**\n\n```python\nproject_path = \"02-projects/NN-{slug}/\"\npapers_path = project_path / \"02-resources/papers\"\n\n# Check briefing exists (with research_purpose - G22a)\nif not exists(project_path / \"02-resources/_briefing.md\"):\n    fail(\"Missing _briefing.md - research question not defined\")\n\nbriefing = read(project_path / \"02-resources/_briefing.md\")\nif 'research_purpose' not in briefing:\n    warn(\"Missing research_purpose in _briefing.md (G22a) - subagents may lack context\")\n\n# Find papers with index.md that have chunk_index (Schema 2.3+)\npapers_valid = []\npapers_legacy = []\nfor folder in papers_path.iterdir():\n    if folder.is_dir() and (folder / \"index.md\").exists():\n        index = read(folder / \"index.md\")\n        if 'chunk_index' in index.frontmatter:\n            papers_valid.append(folder.name)\n        else:\n            papers_legacy.append(folder.name)\n\nif len(papers_valid) < 3:\n    if papers_legacy:\n        fail(f\"\"\"\n        Only {len(papers_valid)} papers have chunk_index (Schema 2.3+).\n        {len(papers_legacy)} papers use legacy schema without chunk_index.\n\n        Re-analyze legacy papers with: \"analyze research project {name}\"\n        Legacy papers: {papers_legacy}\n        \"\"\")\n    else:\n        fail(f\"Only {len(papers_valid)} papers analyzed - need at least 3 for synthesis\")\n\n# Read briefing to get extraction fields\nextraction_fields = briefing.extraction_schema\n```\n\n### Display Status\n\n```\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\nRESEARCH PROJECT READY FOR 7-LEVEL SYNTHESIS\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\n\nResearch Project: {name}\nResearch Qu",
              "sub_steps": [],
              "inputs": [],
              "outputs": [],
              "scripts": [
                "python 03-skills/research-pipeline/shared/contracts/validate_interface.py {project_path}"
              ],
              "script_names": [
                "validate_interface.py"
              ],
              "skills_used": [],
              "subagent": null,
              "gate": null,
              "handoff_to": null,
              "is_script": true,
              "level": null,
              "validation_checks": [
                "Run interface valid",
                "skills/research-pipeline/shared/contracts/valid"
              ],
              "key_outputs": []
            }
          ]
        },
        {
          "letter": "B",
          "name": "ROUTING (Script - Level 1)",
          "steps": [
            {
              "id": "step_2",
              "number": "2",
              "name": "Build Synthesis Routing Table",
              "phase": "B",
              "phase_name": "ROUTING (Script - Level 1)",
              "description": "Run script to build routing from chunk_index.fields_found: What the script does (deterministic - no LLM): 1. Reads all index.md files with chunk_index 2. For each field from _briefing.md: Looks up `chunk_index[N].fields_found[field]` If `true` or `partial` \u2192 add chunk to routing 3. **Sparsity Check (Gap G19)**: Warns if field matches >80% of chunks 4. Outputs routing table Output::...",
              "full_content": "\n\n**Run script to build routing from chunk_index.fields_found:**\n\n```bash\npython 03-skills/research-pipeline/validation/scripts/build_synthesis_routing.py \\\n  {project_path} \\\n  --output 02-resources/_synthesis_routing.yaml\n```\n\n**What the script does (deterministic - no LLM):**\n1. Reads all index.md files with chunk_index\n2. For each field from _briefing.md:\n   - Looks up `chunk_index[N].fields_found[field]`\n   - If `true` or `partial` \u2192 add chunk to routing\n3. **Sparsity Check (Gap G19)**: Warns if field matches >80% of chunks\n4. Outputs routing table\n\n**Output:** `02-resources/_synthesis_routing.yaml`\n\n### Routing Table Structure (NEW - based on chunk_index)\n\n```yaml\nproject: 02-projects/02-ontologies-research\ngenerated_at: \"2025-12-28T14:30:00\"\nalgorithm: \"boolean_lookup\"  # Not full-text search\n\nfields:\n  entity_types:\n    description: \"Core entity types defined\"\n    priority: high\n    sparsity_warning: false  # <80% match rate OK\n    chunks:\n      - paper_id: 02-Knowledge_Graphs\n        chunk: 2\n        fields_found_state: true  # From index.md\n        token_count: 12500        # From index.md\n      - paper_id: 02-Knowledge_Graphs\n        chunk: 6\n        fields_found_state: true\n        token_count: 8200\n      - paper_id: 05-DOLCE\n        chunk: 1\n        fields_found_state: partial  # Partial counts\n        token_count: 15000\n\n  ai_integration:\n    priority: high\n    sparsity_warning: true   # >80% match rate - warn user!\n    chunks:\n      - paper_id: 16-KG-Agent\n        chunk: 1\n        fields_found_state: true\n        token_count: 10000\n\nstats:\n  papers_analyzed: 23\n  total_chunks: 127\n  chunks_per_field_avg: 34\n```\n\n### Display Routing (Level 1)\n\n```\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\nLEVEL 1: SYNTHESIS ROUTING (from chunk_index)\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\n\nFields to synthesize: 15\nTotal chunks routed: 127\n\n| Field | Chunks (true) | Chunks (partial) | Sparsity |\n|-------|---------------|------------------|----------|\n| entity_typ",
              "sub_steps": [],
              "inputs": [],
              "outputs": [],
              "scripts": [
                "python 03-skills/research-pipeline/validation/scripts/build_synthesis_routing.py \\"
              ],
              "script_names": [
                "build_synthesis_routing.py"
              ],
              "skills_used": [],
              "subagent": null,
              "gate": null,
              "handoff_to": null,
              "is_script": true,
              "level": null,
              "validation_checks": [
                "skills/research-pipeline/valid",
                "Sparsity Check"
              ],
              "key_outputs": []
            }
          ]
        },
        {
          "letter": "C",
          "name": "ALLOCATION (Script - Level 2)",
          "steps": [
            {
              "id": "step_3",
              "number": "3",
              "name": "Calculate Subagent Allocation",
              "phase": "C",
              "phase_name": "ALLOCATION (Script - Level 2)",
              "description": "Run script to allocate chunks to subagent batches with token budget: What the script does (deterministic - no LLM): 1. Reads routing table with token counts per chunk 2. Uses greedy bin-packing to fit chunks into 70k token batches 3. Groups chunks by paper when possible (context preservation) 4. Calculates Level 7 budget (Gap G2) 5. Outputs subagent plan Output::...",
              "full_content": "\n\n**Run script to allocate chunks to subagent batches with token budget:**\n\n```bash\npython 03-skills/research-pipeline/validation/scripts/calculate_subagent_allocation.py \\\n  {project_path} \\\n  --input 02-resources/_synthesis_routing.yaml \\\n  --output 02-resources/_subagent_plan.yaml\n```\n\n**What the script does (deterministic - no LLM):**\n1. Reads routing table with token counts per chunk\n2. Uses greedy bin-packing to fit chunks into 70k token batches\n3. Groups chunks by paper when possible (context preservation)\n4. Calculates Level 7 budget (Gap G2)\n5. Outputs subagent plan\n\n**Output:** `02-resources/_subagent_plan.yaml`\n\n### Subagent Plan Structure\n\n```yaml\nproject: 02-projects/02-ontologies-research\ngenerated_at: \"2025-12-28T14:35:00\"\ntoken_budget_per_batch: 70000\nstandard_formula: \"chars // 4\"  # Gap G3\n\n# Level 4 batches (extraction subagents)\nlevel4_batches:\n  - batch_id: \"entity_types_1\"\n    field: entity_types\n    chunks:\n      - paper_id: 02-Knowledge_Graphs\n        chunk: 2\n        token_count: 12500\n      - paper_id: 02-Knowledge_Graphs\n        chunk: 6\n        token_count: 8200\n    total_tokens: 45700\n    estimated_duration: \"3 min\"\n\n  - batch_id: \"entity_types_2\"\n    field: entity_types\n    chunks:\n      - paper_id: 05-DOLCE\n        chunk: 1\n        token_count: 15000\n    total_tokens: 62000\n    estimated_duration: \"4 min\"\n\n# Level 7 budget calculation (Gap G2)\nlevel7_budget:\n  methodology: 3000\n  briefing: 2050  # +50 for research_purpose\n  synthesis_files_estimated: 45000\n  output_reservation: 20000\n  total_available: 100000\n  usable: 29950\n  requires_split: false\n  split_strategy: null\n\nstats:\n  total_batches: 45\n  max_concurrent: 15\n  estimated_total_time: \"25 min\"\n```\n\n### Display Allocation (Level 2)\n\n```\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\nLEVEL 2: SUBAGENT ALLOCATION\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\n\nToken budget per batch: 70,000\nBatches calculated: 45\n\n| Field | Batches | Avg Tokens/Batch |\n|-------|---------|---------------",
              "sub_steps": [],
              "inputs": [],
              "outputs": [],
              "scripts": [
                "python 03-skills/research-pipeline/validation/scripts/calculate_subagent_allocation.py \\"
              ],
              "script_names": [
                "calculate_subagent_allocation.py"
              ],
              "skills_used": [],
              "subagent": null,
              "gate": null,
              "handoff_to": null,
              "is_script": true,
              "level": null,
              "validation_checks": [
                "skills/research-pipeline/valid"
              ],
              "key_outputs": []
            }
          ]
        },
        {
          "letter": "D",
          "name": "PROMPT GENERATION (Script - Level 3)",
          "steps": [
            {
              "id": "step_4",
              "number": "4",
              "name": "Generate Subagent Prompts",
              "phase": "D",
              "phase_name": "PROMPT GENERATION (Script - Level 3)",
              "description": "Run script to generate prompts with INPUT CONTRACT: What the script does (deterministic - no LLM): 1. Reads subagent plan 2. Reads _briefing.md for research_purpose (G22a) 3. Reads _analysis_kit.md for synthesis_goals (G22b) 4. Generates INPUT CONTRACT per subagent (G13) 5. Outputs prompt files Output:: `03-working/prompts/_prompt_{batch_id}.md` name: \"Pattern Name\" chunk_ref: \"Paper-ID (Chunk...",
              "full_content": "\n\n**Run script to generate prompts with INPUT CONTRACT:**\n\n```bash\npython 03-skills/research-pipeline/validation/scripts/generate_subagent_prompts.py \\\n  {project_path} \\\n  --input 02-resources/_subagent_plan.yaml \\\n  --output-dir 03-working/prompts/\n```\n\n**What the script does (deterministic - no LLM):**\n1. Reads subagent plan\n2. Reads _briefing.md for research_purpose (G22a)\n3. Reads _analysis_kit.md for synthesis_goals (G22b)\n4. Generates INPUT CONTRACT per subagent (G13)\n5. Outputs prompt files\n\n**Output:** `03-working/prompts/_prompt_{batch_id}.md`\n\n### Generated Prompt Template\n\n```markdown\n# Batch Extraction: {field_name} (Batch {N} of {total})\n\n## INPUT CONTRACT (STRICT - Gap G13)\n\n### Files You MUST Read (in this order)\n1. `{project_path}/02-resources/_briefing.md`\n2. `{paper_path}/{paper_id}_{chunk}.md`\n[... exact list for this batch]\n\n### Files You MUST NOT Read\n- ANY `.pdf` file\n- ANY other batch's chunks\n- ANY file in 04-outputs/\n\nVIOLATION = Extraction fails validation.\n\n## CONTEXT (Gap G22a, G22b)\nResearch Purpose: {research_purpose}\nSynthesis Goals: {synthesis_goals}\n\n## EXTRACTION CONTRACT\n\nFor field \"{field_name}\":\n1. Read EACH chunk completely\n2. Extract patterns with:\n   - name: Pattern name\n   - chunk_ref: Paper-ID (Chunk N:Line-Line)\n   - quote: \"Exact text from chunk\" (100-150 chars)\n   - description: Full context\n\n3. Write YAML output to: 03-working/_batch_{field}_{N}.yaml\n\n```yaml\npatterns:\n  - name: \"Pattern Name\"\n    chunk_ref: \"Paper-ID (Chunk N:Line-Line)\"\n    quote: \"Exact text proving pattern...\"\n    description: \"Full context and detail\"\n```\n```\n\n### Display Prompts Generated (Level 3)\n\n```\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\nLEVEL 3: PROMPT GENERATION\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\n\nPrompts generated: 45\n\nContext included:\n  \u2713 INPUT CONTRACT (G13)\n  \u2713 research_purpose (G22a)\n  \u2713 synthesis_goals (G22b)\n\nPrompts saved to: 03-working/prompts/\n\nProceeding with Level 4 (Extraction)...\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501",
              "sub_steps": [],
              "inputs": [],
              "outputs": [],
              "scripts": [
                "python 03-skills/research-pipeline/validation/scripts/generate_subagent_prompts.py \\"
              ],
              "script_names": [
                "generate_subagent_prompts.py"
              ],
              "skills_used": [],
              "subagent": null,
              "gate": null,
              "handoff_to": null,
              "is_script": true,
              "level": null,
              "validation_checks": [
                "skills/research-pipeline/valid"
              ],
              "key_outputs": []
            }
          ]
        },
        {
          "letter": "E",
          "name": "EXTRACTION (Subagents - Level 4)",
          "steps": [
            {
              "id": "step_5",
              "number": "5",
              "name": "Spawn Batch Extraction Subagents",
              "phase": "E",
              "phase_name": "EXTRACTION (Subagents - Level 4)",
              "description": "Spawn subagents with prompt file path (subagent reads prompt, not orchestrator): CRITICAL: Do NOT read prompt content yourself. Pass the file path and let the subagent read it. This saves orchestrator context tokens. Subagent Output:: `03-working/_batch_{field}_{N}.yaml`",
              "full_content": "\n\n**Spawn subagents with prompt file path (subagent reads prompt, not orchestrator):**\n\n```python\n# Get prompt file paths\nprompt_dir = project_path / \"03-working/prompts/\"\nprompts = list(prompt_dir.glob(\"_prompt_*.md\"))\n\n# Spawn in parallel (max 15) - subagent reads prompt file directly\nfor prompt_file in prompts:\n    batch_id = prompt_file.stem.replace(\"_prompt_\", \"\")\n    Task(\n        subagent_type=\"general-purpose\",\n        prompt=f\"Read and follow instructions in: {prompt_file}\",\n        description=f\"Extract {batch_id}\"\n    )\n```\n\n**CRITICAL**: Do NOT read prompt content yourself. Pass the file path and let the subagent read it. This saves orchestrator context tokens.\n\n**Subagent Output:** `03-working/_batch_{field}_{N}.yaml`\n\n### Output Schema (YAML - for script processing)\n\n```yaml\n---\nbatch_id: \"entity_types_1\"\nfield: entity_types\nextracted_at: \"2025-12-28T14:40:00\"\nchunks_read: 3\npatterns_found: 8\n---\n\npatterns:\n  - name: \"Endurant (Continuant)\"\n    chunk_ref: \"02-Knowledge_Graphs (Chunk 2:128-133)\"\n    quote: \"An endurant is wholly present at any time during its existence...\"\n    description: \"Core distinction in UFO ontology between things that persist (endurants) vs events (perdurants)\"\n\n  - name: \"Perdurant (Occurrent)\"\n    chunk_ref: \"02-Knowledge_Graphs (Chunk 2:131-135)\"\n    quote: \"A perdurant can only be partially present at any moment...\"\n    description: \"Events, processes, activities - things that unfold over time\"\n```\n\n### Concurrency Settings\n\n| Setting | Value | Notes |\n|---------|-------|-------|\n| Max concurrent subagents | 15 | Parallel extraction |\n| Timeout per batch | 5 min | Generous for large batches |\n| Retry on failure | 1 | Single retry |\n\n### Progress Display (Level 4)\n\n```\nSpawning extraction subagents...\n  [entity_types_1] COMPLETE (3 chunks, 8 patterns)\n  [entity_types_2] COMPLETE (4 chunks, 12 patterns)\n  [entity_types_3] IN_PROGRESS\n  [ai_integration_1] COMPLETE (5 chunks, 15 patterns)\n  ...\n\nExtracted: 38/45 batches\nIn progr",
              "sub_steps": [],
              "inputs": [],
              "outputs": [],
              "scripts": [],
              "script_names": [],
              "skills_used": [],
              "subagent": {
                "type": "general-purpose",
                "concurrency": 1,
                "timeout": "5 min",
                "retry": 1,
                "input_contract": [],
                "output_contract": []
              },
              "gate": null,
              "handoff_to": null,
              "is_script": true,
              "level": null,
              "validation_checks": [],
              "key_outputs": []
            }
          ]
        },
        {
          "letter": "F",
          "name": "VERIFICATION (Script - Level 5)",
          "steps": [
            {
              "id": "step_6",
              "number": "6",
              "name": "Verify Subagent Outputs",
              "phase": "F",
              "phase_name": "VERIFICATION (Script - Level 5)",
              "description": "Run script to verify subagent outputs with quote-line verification (Gap G15): What the script does (deterministic - no LLM): 1. Reads all _batch_{field}_{N}.yaml files 2. For each batch, samples 10% of patterns 3. For each sampled pattern: Parses chunk_ref: \"Paper-ID (Chunk N:Line-Line)\" Reads the actual chunk file Checks if quote exists at cited lines (\u00b15 lines tolerance) 4. Reports verification...",
              "full_content": "\n\n**Run script to verify subagent outputs with quote-line verification (Gap G15):**\n\n```bash\npython 03-skills/research-pipeline/validation/scripts/verify_subagent_output.py \\\n  {project_path} \\\n  --input-dir 03-working/ \\\n  --sample-rate 0.1 \\\n  --output 03-working/_verification_report.yaml\n```\n\n**What the script does (deterministic - no LLM):**\n1. Reads all _batch_{field}_{N}.yaml files\n2. For each batch, samples 10% of patterns\n3. For each sampled pattern:\n   - Parses chunk_ref: \"Paper-ID (Chunk N:Line-Line)\"\n   - Reads the actual chunk file\n   - Checks if quote exists at cited lines (\u00b15 lines tolerance)\n4. Reports verification pass/fail\n\n**Output:** `03-working/_verification_report.yaml`\n\n### Verification Report Structure\n\n```yaml\nverified_at: \"2025-12-28T14:50:00\"\nsample_rate: 0.1\nbatches_checked: 45\npatterns_sampled: 120\npatterns_verified: 112\npatterns_failed: 8\n\nfailures:\n  - batch_id: \"entity_types_2\"\n    pattern: \"Perdurant Definition\"\n    chunk_ref: \"05-DOLCE (Chunk 1:150-155)\"\n    expected_quote: \"A perdurant can only...\"\n    actual_at_lines: \"Different text found\"\n    verdict: \"FAIL - quote mismatch\"\n\nstats:\n  verification_rate: 93.3%\n  threshold: 90%\n  verdict: \"PASS\"\n```\n\n### Display Verification (Level 5)\n\n```\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\nLEVEL 5: QUOTE-LINE VERIFICATION (Gap G15)\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\n\nBatches verified: 45\nPatterns sampled: 120 (10%)\nPatterns verified: 112 (93.3%)\nPatterns failed: 8\n\n\u26a0\ufe0f Failed patterns:\n  entity_types_2: \"Perdurant Definition\" - quote mismatch\n  ai_integration_3: \"Agent Handoff\" - line drift\n\nVerdict: PASS (93.3% > 90% threshold)\n\nProceeding with Level 6 (Aggregation)...\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\n```\n\n### Handle Verification Failure (<90%)\n\nIf verification rate < 90%:\n1. Identify worst-performing batches\n2. Re-run extraction for those batches only\n3. Re-verify\n\n---\n\n# PHASE G: AGGREGATION (Script - Level 6)\n\n",
              "sub_steps": [],
              "inputs": [],
              "outputs": [],
              "scripts": [
                "python 03-skills/research-pipeline/validation/scripts/verify_subagent_output.py \\"
              ],
              "script_names": [
                "verify_subagent_output.py"
              ],
              "skills_used": [],
              "subagent": null,
              "gate": null,
              "handoff_to": null,
              "is_script": true,
              "level": null,
              "validation_checks": [
                "Run script to verify",
                "skills/research-pipeline/validation/scripts/verify",
                "Checks if quote exists"
              ],
              "key_outputs": []
            }
          ]
        },
        {
          "letter": "G",
          "name": "AGGREGATION (Script - Level 6)",
          "steps": [
            {
              "id": "step_7",
              "number": "7",
              "name": "Aggregate Patterns",
              "phase": "G",
              "phase_name": "AGGREGATION (Script - Level 6)",
              "description": "Run script to merge patterns across batches (deterministic - no LLM): What the script does (deterministic - no LLM): 1. Reads all _batch_{field}_{N}.yaml for each field 2. Merges patterns by name (fuzzy match with 90% similarity) 3. Combines sources: if Pattern X appears in 3 batches, all 3 sources merged 4. Outputs aggregated YAML per field Output:: `04-outputs/_synthesis_{field}.yaml`",
              "full_content": "\n\n**Run script to merge patterns across batches (deterministic - no LLM):**\n\n```bash\npython 03-skills/research-pipeline/validation/scripts/aggregate_patterns.py \\\n  {project_path} \\\n  --input-dir 03-working/ \\\n  --output-dir 04-outputs/\n```\n\n**What the script does (deterministic - no LLM):**\n1. Reads all _batch_{field}_{N}.yaml for each field\n2. Merges patterns by name (fuzzy match with 90% similarity)\n3. Combines sources: if Pattern X appears in 3 batches, all 3 sources merged\n4. Outputs aggregated YAML per field\n\n**Output:** `04-outputs/_synthesis_{field}.yaml`\n\n### Aggregated Field Structure\n\n```yaml\nfield: entity_types\naggregated_at: \"2025-12-28T14:55:00\"\nbatches_merged: 6\npatterns_input: 45\npatterns_output: 23  # After deduplication\n\npatterns:\n  - name: \"Endurant (Continuant)\"\n    sources:\n      - chunk_ref: \"02-Knowledge_Graphs (Chunk 2:128-133)\"\n        quote: \"An endurant is wholly present...\"\n      - chunk_ref: \"05-DOLCE (Chunk 1:89-95)\"\n        quote: \"DOLCE distinguishes endurants...\"\n      - chunk_ref: \"23-UFO (Chunk 1:173-180)\"\n        quote: \"In UFO, endurants are...\"\n    description: \"Merged from 3 sources. Core distinction: entities wholly present at any time.\"\n\n  - name: \"Perdurant (Occurrent)\"\n    sources:\n      - chunk_ref: \"02-Knowledge_Graphs (Chunk 2:131-135)\"\n        quote: \"A perdurant can only be partially present...\"\n    description: \"Events and processes that unfold over time.\"\n```\n\n### Display Aggregation (Level 6)\n\n```\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\nLEVEL 6: PATTERN AGGREGATION\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\n\n| Field | Patterns In | Patterns Out | Dedup Rate |\n|-------|-------------|--------------|------------|\n| entity_types | 45 | 23 | 49% |\n| ai_integration | 52 | 31 | 40% |\n| framework_comparison | 38 | 22 | 42% |\n...\n\nTotal patterns: 280 \u2192 156 (44% deduplication)\n\nAggregated files saved to: 04-outputs/_synthesis_*.yaml\n\nProceeding with Level 7 (Final Report)...\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\n``",
              "sub_steps": [],
              "inputs": [],
              "outputs": [],
              "scripts": [
                "python 03-skills/research-pipeline/validation/scripts/aggregate_patterns.py \\"
              ],
              "script_names": [
                "aggregate_patterns.py"
              ],
              "skills_used": [],
              "subagent": null,
              "gate": null,
              "handoff_to": null,
              "is_script": true,
              "level": null,
              "validation_checks": [
                "skills/research-pipeline/valid"
              ],
              "key_outputs": []
            }
          ]
        },
        {
          "letter": "H",
          "name": "FINAL REPORT (Subagent - Level 7)",
          "steps": [
            {
              "id": "step_8",
              "number": "8",
              "name": "Generate Synthesis Report",
              "phase": "H",
              "phase_name": "FINAL REPORT (Subagent - Level 7)",
              "description": "Spawn final report subagent with token budget (Gap G2):",
              "full_content": "\n\n**Spawn final report subagent with token budget (Gap G2):**\n\n### Pre-Check: Token Budget\n\n```python\n# Read Level 7 budget from _subagent_plan.yaml\nplan = read(f\"{project_path}/02-resources/_subagent_plan.yaml\")\nbudget = plan['level7_budget']\n\nif budget['requires_split']:\n    # Need multiple Level 7 passes\n    # Group fields by priority from _briefing.md\n    high_priority = [f for f in fields if f['priority'] == 'high']\n    medium_priority = [f for f in fields if f['priority'] == 'medium']\n\n    # Pass 1: High-priority fields\n    spawn_level7_subagent(high_priority, output=\"_synthesis_report_high.md\")\n    # Pass 2: Medium-priority fields\n    spawn_level7_subagent(medium_priority, output=\"_synthesis_report_medium.md\")\n    # Pass 3: Merge\n    spawn_level7_merge_subagent()\nelse:\n    # Single pass - fits in budget\n    spawn_level7_subagent(all_fields, output=\"_synthesis_report.md\")\n```\n\n### Final Report Subagent Prompt (WITH BUDGET)\n\n```markdown\n# FINAL SYNTHESIS REPORT (Level 7)\n\n## TOKEN BUDGET (Gap G2)\nYou have LIMITED context. Stay within budget:\n- Synthesis files: {synthesis_tokens} tokens\n- Methodology: 3,000 tokens\n- Output reservation: 20,000 tokens\n- Usable: {usable_tokens} tokens\n\n## INPUT CONTRACT (STRICT)\nRead these files ONLY:\n1. `{project_path}/02-resources/_briefing.md`\n2. `{project_path}/04-outputs/_synthesis_entity_types.yaml`\n3. `{project_path}/04-outputs/_synthesis_ai_integration.yaml`\n[... exact list from _subagent_plan.yaml]\n\nDO NOT read chunk files directly - use citations from synthesis files.\n\n## CONTEXT\nResearch Question: {research_question}\nResearch Purpose: {research_purpose}\n\n## OUTPUT CONTRACT\nWrite to: `{project_path}/04-outputs/_synthesis_report.md`\n\nStructure:\n1. Executive Summary (3-4 paragraphs answering RQ with citations)\n2. Key Findings (5-8 findings with evidence tables)\n3. Cross-Field Insights (patterns spanning multiple fields)\n4. Recommendations (3-5 with supporting evidence)\n5. Limitations\n6. Appendix A: Field Summaries\n7. Append",
              "sub_steps": [],
              "inputs": [],
              "outputs": [],
              "scripts": [],
              "script_names": [],
              "skills_used": [],
              "subagent": {
                "type": "general-purpose",
                "concurrency": 1,
                "timeout": "5 min",
                "retry": 1,
                "input_contract": [
                  "outputs/_synthesis_report.md`",
                  "4 paragraphs answering RQ with citations)",
                  "8 findings with evidence tables)",
                  "Field Insights (patterns spanning multiple fields)",
                  "5 with supporting evidence)"
                ],
                "output_contract": []
              },
              "gate": null,
              "handoff_to": null,
              "is_script": false,
              "level": 7,
              "validation_checks": [],
              "key_outputs": []
            }
          ]
        },
        {
          "letter": "I",
          "name": "COMPLETION",
          "steps": [
            {
              "id": "step_9",
              "number": "9",
              "name": "Mark Project COMPLETE",
              "phase": "I",
              "phase_name": "COMPLETION",
              "description": "Update project status: Rule: Script levels output YAML, final subagent outputs Markdown. 1. **SCRIPTS ARE DETERMINISTIC** - Levels 1-3, 5-6 use Python scripts, NOT LLM 2. **ONLY 2 SUBAGENT LEVELS** - Level 4 (extraction) and Level 7 (report) use LLM 3. **PRESERVE CITATIONS** - Every level keeps Paper-ID (Chunk:Line) 4. **TOKEN BUDGET IS REAL** - Level 7 has calculated budget, can split 5....",
              "full_content": "\n\n**Update project status:**\n\n### Update overview.md\n\n```yaml\nstatus: COMPLETE\ncompleted_at: \"{timestamp}\"\nsynthesis_version: \"7-level\"\n```\n\n### Final Summary\n\n```\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\n7-LEVEL SYNTHESIS COMPLETE\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\n\nProject: {name}\nResearch Question: \"{RQ}\"\nResearch Purpose: \"{purpose}\"\n\nPipeline Summary:\n  Level 1 (Routing):     127 chunks routed\n  Level 2 (Allocation):  45 batches calculated\n  Level 3 (Prompts):     45 prompts generated\n  Level 4 (Extraction):  45 batches extracted\n  Level 5 (Verification): 93.3% verified\n  Level 6 (Aggregation): 156 unique patterns\n  Level 7 (Report):      1 comprehensive report\n\nOutputs:\n  \ud83d\udcc4 04-outputs/_synthesis_report.md (FULL REPORT)\n  \ud83d\udcca 04-outputs/_synthesis_{field}.yaml ({M} field aggregations)\n  \ud83d\udccb 03-working/_verification_report.yaml\n\nDeterministic Scripts Used:\n  \u2713 build_synthesis_routing.py (Level 1)\n  \u2713 calculate_subagent_allocation.py (Level 2)\n  \u2713 generate_subagent_prompts.py (Level 3)\n  \u2713 verify_subagent_output.py (Level 5)\n  \u2713 aggregate_patterns.py (Level 6)\n\nNext steps:\n  \u2022 Review synthesis report\n  \u2022 Export findings\n  \u2022 Archive or close project\n\nSay \"close session\" to save learnings.\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\n```\n\n---\n\n## Files Created by This Skill\n\n| File | Location | Purpose | Level |\n|------|----------|---------|-------|\n| `_synthesis_routing.yaml` | 02-resources/ | Routing table (from chunk_index) | L1 |\n| `_subagent_plan.yaml` | 02-resources/ | Allocation + token budgets | L2 |\n| `_prompt_{batch_id}.md` | 03-working/prompts/ | Generated subagent prompts | L3 |\n| `_batch_{field}_{N}.yaml` | 03-working/ | Batch extraction outputs (YAML) | L4 |\n| `_verification_report.yaml` | 03-working/ | Quote-line verification | L5 |\n| `_synthesis_{field}.yaml` | 04-outputs/ | Per-field aggregation (YAML) | L6 |\n| `_synthesis_report.md` | 04-outputs/ | FULL FINAL REPORT (Markdown) | L7 |\n\n---\n\n## Output Format by Level\n\n| Level | Output Format ",
              "sub_steps": [],
              "inputs": [],
              "outputs": [],
              "scripts": [],
              "script_names": [],
              "skills_used": [],
              "subagent": null,
              "gate": null,
              "handoff_to": null,
              "is_script": true,
              "level": null,
              "validation_checks": [
                "Added Level 5 (Verification) with quote-line check"
              ],
              "key_outputs": [
                "_synthesis_routing.yaml: 02-resources/",
                "_subagent_plan.yaml: 02-resources/",
                "_prompt_{batch_id}.md: 03-working/prompts/",
                "_batch_{field}_{N}.yaml: 03-working/",
                "_verification_report.yaml: 03-working/"
              ]
            }
          ]
        }
      ],
      "handoff_from": null,
      "handoff_to": null,
      "total_steps": 10,
      "total_gates": 0,
      "key_outputs": [
        "_synthesis_routing.yaml: 02-resources/",
        "_subagent_plan.yaml: 02-resources/",
        "_prompt_{batch_id}.md: 03-working/prompts/",
        "_batch_{field}_{N}.yaml: 03-working/",
        "_verification_report.yaml: 03-working/"
      ],
      "version": "2.0 (2025-12-28)"
    }
  ],
  "file_graph": {
    "nodes": {
      "02-resources/_briefing.md": {
        "type": "file",
        "format": "md",
        "producers": [
          "create-research-project:2"
        ],
        "consumers": []
      },
      "_briefing.md": {
        "type": "file",
        "format": "md",
        "producers": [],
        "consumers": [
          "create-research-project:10",
          "analyze-research-project:2"
        ]
      },
      "_analysis_kit.md": {
        "type": "file",
        "format": "md",
        "producers": [
          "create-research-project:10"
        ],
        "consumers": [
          "analyze-research-project:2"
        ]
      },
      "_extraction_guide.md": {
        "type": "file",
        "format": "md",
        "producers": [
          "create-research-project:11"
        ],
        "consumers": []
      },
      "01-planning/plan.md": {
        "type": "file",
        "format": "md",
        "producers": [],
        "consumers": [
          "analyze-research-project:0"
        ]
      },
      "03-skills/research-pipeline/shared/paper-analyze-core/SKILL.md": {
        "type": "file",
        "format": "md",
        "producers": [],
        "consumers": [
          "analyze-research-project:2"
        ]
      },
      "_analysis_log.md": {
        "type": "file",
        "format": "md",
        "producers": [],
        "consumers": [
          "analyze-research-project:4"
        ]
      }
    },
    "edges": [
      {
        "source": "create-research-project:2",
        "target": "02-resources/_briefing.md",
        "type": "output"
      },
      {
        "source": "_briefing.md",
        "target": "create-research-project:10",
        "type": "input"
      },
      {
        "source": "create-research-project:10",
        "target": "_analysis_kit.md",
        "type": "output"
      },
      {
        "source": "create-research-project:11",
        "target": "_extraction_guide.md",
        "type": "output"
      },
      {
        "source": "01-planning/plan.md",
        "target": "analyze-research-project:0",
        "type": "input"
      },
      {
        "source": "_briefing.md",
        "target": "analyze-research-project:2",
        "type": "input"
      },
      {
        "source": "_analysis_kit.md",
        "target": "analyze-research-project:2",
        "type": "input"
      },
      {
        "source": "03-skills/research-pipeline/shared/paper-analyze-core/SKILL.md",
        "target": "analyze-research-project:2",
        "type": "input"
      },
      {
        "source": "_analysis_log.md",
        "target": "analyze-research-project:4",
        "type": "input"
      }
    ]
  },
  "stats": {
    "total_steps": 30,
    "total_gates": 2,
    "total_phases": 16,
    "total_scripts": 10,
    "total_subagents": 7,
    "total_files": 7
  },
  "pipeline": [
    {
      "name": "create-research-project",
      "steps": 14,
      "gates": 2,
      "phases": 4,
      "handoff_to": null,
      "description": "Create research projects with paper selection, download, and preprocessing (Phase 1). Load when user says 'create research project', 'new research', 'start research on [topic]'. Delivers analysis-ready chunks. For EXECUTING analysis, use 'execute-research-project' skill.",
      "version": "5.0 (2025-12-28)",
      "key_outputs": []
    },
    {
      "name": "analyze-research-project",
      "steps": 6,
      "gates": 0,
      "phases": 3,
      "handoff_to": null,
      "description": "Analyze research papers (Phase 2: analysis only). Load when user says 'analyze research project', 'execute research project', 'continue research', 'run analysis', or mentions a research project by name after planning is complete. Expects analysis-ready chunks from create-research-project. After anal",
      "version": "5.0 (2025-12-28)",
      "key_outputs": [
        "_analysis_log.md: 02-resources/papers/{paper}/",
        "index.md: 02-resources/papers/{paper}/",
        "_validation_report.md: 04-outputs/"
      ]
    },
    {
      "name": "synthesize-research-project",
      "steps": 10,
      "gates": 0,
      "phases": 9,
      "handoff_to": null,
      "description": "Synthesize analyzed research papers into comprehensive reports (Phase 3). Load when user says 'synthesize research project', 'generate synthesis', 'create synthesis report', or wants cross-paper synthesis. Expects analyzed papers with index.md from analyze-research-project.",
      "version": "2.0 (2025-12-28)",
      "key_outputs": [
        "_synthesis_routing.yaml: 02-resources/",
        "_subagent_plan.yaml: 02-resources/",
        "_prompt_{batch_id}.md: 03-working/prompts/"
      ]
    }
  ]
};

    let expandedSections = new Set(['create-research-project']);
    let expandedSteps = new Set();

    function getClass(name) {
        if (name.includes('create')) return 'create';
        if (name.includes('analyze')) return 'analyze';
        if (name.includes('synthesize')) return 'synthesize';
        return 'create';
    }

    function getIcon(name) {
        if (name.includes('create')) return '🚀';
        if (name.includes('analyze')) return '🔬';
        if (name.includes('synthesize')) return '✨';
        return '📦';
    }

    function formatName(name) {
        return name.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
    }

    function renderNav() {
        const nav = document.getElementById('sidebar');
        let html = `
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">⚡</div>
                    <div>
                        <div class="logo-text">Research Pipeline</div>
                        <div class="logo-version">v6 · 10x Visualization</div>
                    </div>
                </div>
                <div class="sidebar-stats">
                    <div class="sidebar-stat">
                        <div class="sidebar-stat-value">${DATA.stats.total_steps}</div>
                        <div class="sidebar-stat-label">Steps</div>
                    </div>
                    <div class="sidebar-stat">
                        <div class="sidebar-stat-value">${DATA.stats.total_phases}</div>
                        <div class="sidebar-stat-label">Phases</div>
                    </div>
                    <div class="sidebar-stat">
                        <div class="sidebar-stat-value">${DATA.stats.total_gates}</div>
                        <div class="sidebar-stat-label">Gates</div>
                    </div>
                </div>
            </div>
            <div class="nav" id="nav">
        `;

        DATA.orchestrators.forEach(orch => {
            const isExpanded = expandedSections.has(orch.name);
            const cls = getClass(orch.name);

            html += `
                <div class="nav-section ${isExpanded ? 'expanded' : ''}" data-orch="${orch.name}">
                    <div class="nav-section-header" onclick="toggleSection('${orch.name}')">
                        <div class="nav-section-icon ${cls}">${getIcon(orch.name)}</div>
                        <div class="nav-section-info">
                            <div class="nav-section-title">${formatName(orch.name)}</div>
                            <div class="nav-section-meta">
                                <span>${orch.total_steps} steps</span>
                                <span>${orch.total_gates} gates</span>
                            </div>
                        </div>
                    </div>
                    <div class="nav-items">
            `;

            orch.phases.forEach(phase => {
                html += `<div class="nav-phase">Phase ${phase.letter} · ${phase.name}</div>`;
                phase.steps.forEach(step => {
                    const badges = [];
                    if (step.level) badges.push(`<span class="nav-badge level">${step.level}</span>`);
                    if (step.gate) badges.push('<span class="nav-badge gate">⚡</span>');
                    if (step.subagent) badges.push('<span class="nav-badge subagent">🤖</span>');
                    if (step.is_script) badges.push('<span class="nav-badge script">⚙</span>');

                    html += `
                        <div class="nav-item" data-step="${orch.name}-${step.id}" onclick="scrollToStep('${orch.name}-${step.id}')">
                            <span class="nav-item-step">${step.number}</span>
                            <span class="nav-item-name">${step.name}</span>
                            <span class="nav-item-badges">${badges.join('')}</span>
                        </div>
                    `;
                });
            });

            html += '</div></div>';
        });

        html += '</div>';
        nav.innerHTML = html;
    }

    function toggleSection(name) {
        if (expandedSections.has(name)) {
            expandedSections.delete(name);
        } else {
            expandedSections.add(name);
        }
        renderNav();
    }

    function toggleStep(stepId) {
        const card = document.querySelector(`[data-step-card="${stepId}"]`);
        if (card) {
            card.classList.toggle('expanded');
            expandedSteps.has(stepId) ? expandedSteps.delete(stepId) : expandedSteps.add(stepId);
        }
    }

    function scrollToStep(stepId) {
        const element = document.querySelector(`[data-step-card="${stepId}"]`);
        if (element) {
            element.scrollIntoView({ behavior: 'smooth', block: 'center' });
            element.classList.add('expanded');
            expandedSteps.add(stepId);
        }
    }

    function scrollToSection(name) {
        const section = document.querySelector(`[data-section="${name}"]`);
        if (section) {
            section.scrollIntoView({ behavior: 'smooth' });
            expandedSections.add(name);
            renderNav();
        }
    }

    function renderMain() {
        const main = document.getElementById('main');
        let html = '';

        // Hero
        html += `
            <section class="hero">
                <div class="hero-content">
                    <div class="hero-badge">⚡ 3-Skill Chain · 7-Level Architecture</div>
                    <h1 class="hero-title">Research Pipeline</h1>
                    <p class="hero-subtitle">Complete end-to-end workflow for academic paper research, analysis, and synthesis with full provenance tracking.</p>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${DATA.stats.total_steps}</div>
                            <div class="stat-label">Total Steps</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${DATA.stats.total_phases}</div>
                            <div class="stat-label">Phases</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${DATA.stats.total_gates}</div>
                            <div class="stat-label">User Gates</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${DATA.stats.total_scripts}</div>
                            <div class="stat-label">Scripts</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${DATA.stats.total_subagents}</div>
                            <div class="stat-label">Subagent Steps</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${DATA.stats.total_files}</div>
                            <div class="stat-label">File Types</div>
                        </div>
                    </div>

                    <div class="pipeline-diagram">
        `;

        DATA.pipeline.forEach((node, i) => {
            const cls = getClass(node.name);
            const outputs = node.key_outputs || [];

            html += `
                <div class="pipeline-node ${cls}" onclick="scrollToSection('${node.name}')">
                    <div class="pipeline-node-header">
                        <div class="pipeline-node-icon">${getIcon(node.name)}</div>
                        <div>
                            <div class="pipeline-node-title">${formatName(node.name)}</div>
                            <div class="pipeline-node-phase">Phase ${i + 1} · v${node.version || '?'}</div>
                        </div>
                    </div>
                    <div class="pipeline-node-desc">${node.description || ''}</div>
                    <div class="pipeline-node-stats">
                        <div class="pipeline-node-stat"><strong>${node.steps}</strong> steps</div>
                        <div class="pipeline-node-stat"><strong>${node.phases}</strong> phases</div>
                        <div class="pipeline-node-stat"><strong>${node.gates}</strong> gates</div>
                    </div>
                    ${outputs.length > 0 ? `
                        <div class="pipeline-outputs">
                            ${outputs.slice(0, 2).map(o => `
                                <div class="pipeline-output">
                                    <span class="pipeline-output-icon">→</span>
                                    <span>${o}</span>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;

            if (i < DATA.pipeline.length - 1) {
                html += `
                    <div class="pipeline-arrow">
                        <div class="pipeline-arrow-line"></div>
                    </div>
                `;
            }
        });

        html += '</div></div></section>';

        // Sections
        DATA.orchestrators.forEach(orch => {
            const cls = getClass(orch.name);

            html += `
                <section class="section" id="${orch.name}" data-section="${orch.name}">
                    <div class="section-header">
                        <div class="section-icon ${cls}">${getIcon(orch.name)}</div>
                        <div class="section-info">
                            <h2>${formatName(orch.name)}</h2>
                            <p>${orch.description || ''}</p>
                            <div class="section-meta">
                                <span class="section-meta-item"><strong>${orch.total_steps}</strong> steps</span>
                                <span class="section-meta-item"><strong>${orch.phases.length}</strong> phases</span>
                                <span class="section-meta-item"><strong>${orch.total_gates}</strong> gates</span>
                                ${orch.version ? `<span class="section-meta-item">v${orch.version}</span>` : ''}
                            </div>
                        </div>
                    </div>
            `;

            orch.phases.forEach(phase => {
                html += `
                    <div class="phase-header">
                        <div class="phase-letter ${phase.letter}">${phase.letter}</div>
                        <div class="phase-info">
                            <div class="phase-name">${phase.name}</div>
                            <div class="phase-meta">${phase.steps.length} steps</div>
                        </div>
                    </div>
                `;

                phase.steps.forEach(step => {
                    const stepId = `${orch.name}-${step.id}`;
                    const isExpanded = expandedSteps.has(stepId);

                    html += `
                        <div class="step-card ${isExpanded ? 'expanded' : ''}" data-step-card="${stepId}" id="${stepId}">
                            <div class="step-card-header" onclick="toggleStep('${stepId}')">
                                <div class="step-number">${step.number}</div>
                                <div class="step-info">
                                    <div class="step-title">${step.name}</div>
                                    <div class="step-description">${step.description || ''}</div>
                                    <div class="step-meta">
                                        ${step.level ? `<span class="step-meta-badge level">Level ${step.level}</span>` : ''}
                                        ${step.is_script ? '<span class="step-meta-badge script">⚙️ Script</span>' : ''}
                                        ${step.subagent ? '<span class="step-meta-badge subagent">🤖 Subagent</span>' : ''}
                                        ${step.gate ? '<span class="step-meta-badge gate">⚡ Gate</span>' : ''}
                                    </div>
                                </div>
                                <div class="step-expand">▼</div>
                            </div>
                            <div class="step-content">
                                ${renderStepContent(step)}
                            </div>
                        </div>
                    `;
                });
            });

            html += '</section>';
        });

        // Footer
        html += `
            <footer class="footer">
                <div class="footer-content">
                    <div class="footer-logo">Research Pipeline Visualizer v6</div>
                    <div class="footer-meta">Generated ${new Date().toLocaleString()} · 10x Better Edition</div>
                </div>
            </footer>
        `;

        main.innerHTML = html;
    }

    function renderStepContent(step) {
        let html = '';

        // Sub-steps
        if (step.sub_steps && step.sub_steps.length > 0) {
            html += `
                <div class="content-section">
                    <div class="content-section-title">📋 Sub-steps (${step.sub_steps.length})</div>
                    <div class="substeps">
                        ${step.sub_steps.map(ss => `
                            <div class="substep">
                                <div class="substep-number">${ss.number}</div>
                                <div class="substep-info">
                                    <div class="substep-name">${ss.name}</div>
                                    ${ss.description ? `<div class="substep-desc">${ss.description}</div>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Inputs
        if (step.inputs && step.inputs.length > 0) {
            html += `
                <div class="content-section">
                    <div class="content-section-title">📥 Inputs (${step.inputs.length})</div>
                    <div class="files-grid">
                        ${step.inputs.map(f => `
                            <div class="file-item">
                                <div class="file-icon input">→</div>
                                <div class="file-info">
                                    <div class="file-path">${f.path}</div>
                                    <div class="file-format">${f.format}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Outputs
        if (step.outputs && step.outputs.length > 0) {
            html += `
                <div class="content-section">
                    <div class="content-section-title">📤 Outputs (${step.outputs.length})</div>
                    <div class="files-grid">
                        ${step.outputs.map(f => `
                            <div class="file-item">
                                <div class="file-icon output">✓</div>
                                <div class="file-info">
                                    <div class="file-path">${f.path}</div>
                                    <div class="file-format">${f.format}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Scripts
        if (step.scripts && step.scripts.length > 0) {
            html += `
                <div class="content-section">
                    <div class="content-section-title">⚙️ Scripts (${step.scripts.length})</div>
                    <div class="scripts-list">
                        ${step.scripts.map((cmd, i) => `
                            <div class="script-item">
                                <div class="script-header">
                                    <div class="script-icon">⚙️</div>
                                    <div class="script-name">${step.script_names && step.script_names[i] ? step.script_names[i] : 'Script'}</div>
                                </div>
                                <div class="script-command">${cmd}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Subagent
        if (step.subagent) {
            const sa = step.subagent;
            html += `
                <div class="content-section">
                    <div class="content-section-title">🤖 Subagent Configuration</div>
                    <div class="subagent-card">
                        <div class="subagent-header">
                            <div class="subagent-icon">🤖</div>
                            <div>
                                <div class="subagent-title">Parallel Subagents</div>
                                <div class="subagent-type">${sa.type}</div>
                            </div>
                        </div>
                        <div class="subagent-stats">
                            <div class="subagent-stat">
                                <div class="subagent-stat-value">${sa.concurrency}</div>
                                <div class="subagent-stat-label">Max Parallel</div>
                            </div>
                            <div class="subagent-stat">
                                <div class="subagent-stat-value">${sa.timeout}</div>
                                <div class="subagent-stat-label">Timeout</div>
                            </div>
                            <div class="subagent-stat">
                                <div class="subagent-stat-value">${sa.retry}</div>
                                <div class="subagent-stat-label">Retries</div>
                            </div>
                        </div>
                        <div class="subagent-visual">
                            ${Array(Math.min(sa.concurrency, 15)).fill(0).map(() => '<div class="subagent-slot">▶</div>').join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // Gate
        if (step.gate) {
            html += `
                <div class="content-section">
                    <div class="content-section-title">⚡ User Decision Gate</div>
                    <div class="gate-card">
                        <div class="gate-header">
                            <div class="gate-icon">⚡</div>
                            <div>
                                <div class="gate-title">${step.gate.name || 'Decision Point'}</div>
                                <div class="gate-subtitle">User approval required</div>
                            </div>
                        </div>
                        <div class="gate-options">
                            ${step.gate.options.map(opt => `
                                <div class="gate-option">
                                    <div class="gate-key">${opt.key}</div>
                                    <div class="gate-label">${opt.label}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // Validation checks
        if (step.validation_checks && step.validation_checks.length > 0) {
            html += `
                <div class="content-section">
                    <div class="content-section-title">✓ Validation Checks</div>
                    <div class="validation-list">
                        ${step.validation_checks.map(check => `
                            <div class="validation-item">
                                <span class="validation-icon">✓</span>
                                <span>${check}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        return html || '<div style="color: var(--text-muted); padding: 20px;">No additional details for this step.</div>';
    }

    // Scroll spy
    function updateScrollSpy() {
        const sections = document.querySelectorAll('[data-section]');
        const steps = document.querySelectorAll('[data-step-card]');
        const scrollY = window.scrollY;
        const windowHeight = window.innerHeight;

        // Progress bar
        const docHeight = document.documentElement.scrollHeight - windowHeight;
        const progress = (scrollY / docHeight) * 100;
        document.getElementById('progressBar').style.width = progress + '%';

        // Current section
        let currentSection = null;
        sections.forEach(section => {
            const rect = section.getBoundingClientRect();
            if (rect.top <= windowHeight / 3) {
                currentSection = section.dataset.section;
            }
        });

        document.querySelectorAll('.nav-section-header').forEach(header => {
            const section = header.closest('.nav-section');
            if (section && section.dataset.orch === currentSection) {
                header.classList.add('active');
            } else {
                header.classList.remove('active');
            }
        });

        // Current step
        let currentStep = null;
        steps.forEach(step => {
            const rect = step.getBoundingClientRect();
            if (rect.top <= windowHeight / 2 && rect.bottom > 0) {
                currentStep = step.dataset.stepCard;
            }
        });

        document.querySelectorAll('.nav-item').forEach(item => {
            if (item.dataset.step === currentStep) {
                item.classList.add('active');
            } else {
                item.classList.remove('active');
            }
        });
    }

    let scrollTimeout;
    window.addEventListener('scroll', () => {
        if (scrollTimeout) return;
        scrollTimeout = setTimeout(() => {
            updateScrollSpy();
            scrollTimeout = null;
        }, 50);
    });

    // Init
    renderNav();
    renderMain();
    updateScrollSpy();
    </script>
</body>
</html>